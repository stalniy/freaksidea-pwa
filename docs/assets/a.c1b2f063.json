{"title":"Magento backend - создание CRUD модуля","summary":"Продолжая серию статей, сегодня я покажу, как создать модуль для\nредактирования цитат в админ-панели Magento.\n","author":"sstotskyi","categories":["backend","important"],"createdAt":"2011-02-02T17:21:00.000Z","meta":{"keywords":["magento","модуль","backend"]},"alias":"magento-backend---sozdanie-crud-modulya","content":"<p>Если Вы пропустили предыдущую статью, то нужно скачать вот <a href=\"/media/assets/Freak_Quotes_All.zip\" download=\"Freak_Quotes_All.zip\">ЭТО</a>.</p>\n<h2 id=\"rekonfiguring\"><a name=\"rekonfiguring\" class=\"h-link\" href=\"#\"></a>Реконфигуринг</h2>\n<p>Как всегда начнем работу с добавления файлов/папок в структуру нашего модуля.</p>\n<pre><code class=\"hljs language-bash\">|-app\n|---code\n|-----<span class=\"hljs-built_in\">local</span>\n|-------Freaks\n|---------Quotes\n|-----------Block\n|-------------Adminhtml\n|---------------Edit\n|-----------------Form.php\n|---------------Quotes\n|-----------------Grid.php\n|---------------Edit.php\n|---------------Quotes.php\n|-----------controllers\n|-------------Adminhtml\n|---------------QuotesController.php\n|-----------etc\n|-------------config.xml\n|-------------adminhtml.xml\n|-----------Helper\n|-----------Model\n|-----------sql\n|---design\n|-----adminhtml\n|-------default\n|---------default\n|-----------layout\n|-------------freaks\n|---------------quotes.xml\n</code></pre>\n<p>Добавим в файл конфигурации (<strong>app/code/local/Freaks/Quotes/etc/config.xml</strong>) новые настройки</p>\n<pre><code class=\"hljs language-xml\"><span class=\"hljs-meta\">&lt;?xml version=\"1.0\"?&gt;</span>\n<span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">config</span>&gt;</span>\n...........................................\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">adminhtml</span>&gt;</span>\n        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">layout</span>&gt;</span>\n            <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">updates</span>&gt;</span>\n                <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">freaks_quotes</span>&gt;</span>\n                    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">file</span>&gt;</span>freaks/quotes.xml<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">file</span>&gt;</span>\n                <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">freaks_quotes</span>&gt;</span>\n            <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">updates</span>&gt;</span>\n        <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">layout</span>&gt;</span>\n    <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">adminhtml</span>&gt;</span>\n   <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">admin</span>&gt;</span>\n        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">routers</span>&gt;</span>\n             <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">adminhtml</span>&gt;</span>\n                 <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">args</span>&gt;</span>\n                     <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">modules</span>&gt;</span>\n                         <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">freaks_quotes</span> <span class=\"hljs-attr\">before</span>=<span class=\"hljs-string\">\"Mage_Adminhtml\"</span>&gt;</span>Freaks_Quotes_Adminhtml<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">freaks_quotes</span>&gt;</span>\n                     <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">modules</span>&gt;</span>\n                 <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">args</span>&gt;</span>\n             <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">adminhtml</span>&gt;</span>\n        <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">routers</span>&gt;</span>\n    <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">admin</span>&gt;</span>\n<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">config</span>&gt;</span>\n</code></pre>\n<ul>\n<li><em>adminhtml</em>/<em>layout</em> - указывает на файл с изменения к макету, по аналогии, как на frontend-е.</li>\n<li><em>admin/routers</em> - указывает способ работы роутинга. Эти директива означает, что модуль Freaks_Quotes должен использоваться в тех случаях, когда обратится к админ части модуля. В параметр задаем префикс для всех классов, отвечающих за роботу с backend-ом</li>\n</ul>\n<p>В директории настроек появился еще один странный файл с именем <strong>adminhtml.xml</strong>. Постмотрим что же в нем можна задать</p>\n<pre><code class=\"hljs language-xml\"><span class=\"hljs-meta\">&lt;?xml version=\"1.0\"?&gt;</span>\n<span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">config</span>&gt;</span>\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">menu</span>&gt;</span>\n        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">freaks_quotes</span> <span class=\"hljs-attr\">translate</span>=<span class=\"hljs-string\">\"title\"</span> <span class=\"hljs-attr\">module</span>=<span class=\"hljs-string\">\"freaks_quotes\"</span>&gt;</span>\n            <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">title</span>&gt;</span>Quotes<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">title</span>&gt;</span>\n            <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">sort_order</span>&gt;</span>55<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">sort_order</span>&gt;</span>\n            <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">action</span>&gt;</span>adminhtml/quotes<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">action</span>&gt;</span>\n        <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">freaks_quotes</span>&gt;</span>\n    <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">menu</span>&gt;</span>\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">acl</span>&gt;</span>\n        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">resources</span>&gt;</span>\n            <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">admin</span>&gt;</span>\n                <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">children</span>&gt;</span>\n                    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">freaks_quotes</span> <span class=\"hljs-attr\">translate</span>=<span class=\"hljs-string\">\"title\"</span> <span class=\"hljs-attr\">module</span>=<span class=\"hljs-string\">\"freaks_quotes\"</span>&gt;</span>\n                        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">title</span>&gt;</span>Quotes<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">title</span>&gt;</span>\n                        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">sort_order</span>&gt;</span>0<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">sort_order</span>&gt;</span>\n                    <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">freaks_quotes</span>&gt;</span>\n                <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">children</span>&gt;</span>\n            <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">admin</span>&gt;</span>\n        <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">resources</span>&gt;</span>\n    <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">acl</span>&gt;</span>\n<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">config</span>&gt;</span>\n</code></pre>\n<p>Видим, что с его помощью можно добавить в меню новый пункт, переходя по-которому сможем попасть на список всех цитат. В директиве <em>menu</em> думаю все понятно, за исключением <em>action</em>. Он указывает Magento, какой нужно использовать URL для index страницы модуля. После &quot;adminhtml/&quot; идет название контроллера в директории <strong>controllers/Adminhtml</strong>.</p>\n<p><em>acl</em> - это access level, который можно изменять на Magento backend-е - <strong>Sytem</strong> &gt; <strong>Permissions</strong> &gt; <strong>Roles</strong>. В нашем случае права или даются на весь модуль или вообще не даются.</p>\n<p>Создадим layout-файл для backend-а (<strong>app/design/adminhtml/default/default/layout/freaks/quotes.xml</strong>)</p>\n<pre><code class=\"hljs language-xml\"><span class=\"hljs-meta\">&lt;?xml version=\"1.0\"?&gt;</span>\n<span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">layout</span> <span class=\"hljs-attr\">version</span>=<span class=\"hljs-string\">\"0.1.0\"</span>&gt;</span>\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">adminhtml_quotes_index</span>&gt;</span>\n        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">reference</span> <span class=\"hljs-attr\">name</span>=<span class=\"hljs-string\">\"content\"</span>&gt;</span>\n            <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">block</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"freaks_quotes/adminhtml_quotes\"</span> <span class=\"hljs-attr\">name</span>=<span class=\"hljs-string\">\"quotes.grid_container\"</span> /&gt;</span>\n        <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">reference</span>&gt;</span>\n    <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">adminhtml_quotes_index</span>&gt;</span>\n\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">adminhtml_quotes_new</span>&gt;</span>\n        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">update</span> <span class=\"hljs-attr\">handle</span>=<span class=\"hljs-string\">\"adminhtml_quotes_edit\"</span>/&gt;</span>\n    <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">adminhtml_quotes_new</span>&gt;</span>\n\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">adminhtml_quotes_edit</span>&gt;</span>\n        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">reference</span> <span class=\"hljs-attr\">name</span>=<span class=\"hljs-string\">\"content\"</span>&gt;</span>\n            <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">block</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"freaks_quotes/adminhtml_edit\"</span> <span class=\"hljs-attr\">name</span>=<span class=\"hljs-string\">\"quotes.edit\"</span> /&gt;</span>\n        <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">reference</span>&gt;</span>\n    <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">adminhtml_quotes_edit</span>&gt;</span>\n<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">layout</span>&gt;</span>\n</code></pre>\n<p>В этой конфигурации появилась новая директива - &quot;update&quot;. Все что он делает - это указывает, настройки из какого <em>handle-а</em> нужно использовать здесь.</p>\n<h2 id=\"kontroliruem\"><a name=\"kontroliruem\" class=\"h-link\" href=\"#\"></a>Контролируем</h2>\n<p>Создаем то без чего ничего не работает - вот он контроллер</p>\n<pre><code class=\"hljs language-php\"><span class=\"hljs-meta\">&lt;?php</span>\n<span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">Freaks_Quotes_Adminhtml_QuotesController</span> <span class=\"hljs-keyword\">extends</span> <span class=\"hljs-title\">Mage_Adminhtml_Controller_Action</span>\n</span>{\n    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">indexAction</span><span class=\"hljs-params\">()</span>\n    </span>{\n        <span class=\"hljs-keyword\">$this</span>-&gt;_title(<span class=\"hljs-keyword\">$this</span>-&gt;__(<span class=\"hljs-string\">'Quotes'</span>));\n\n        <span class=\"hljs-keyword\">$this</span>-&gt;loadLayout();\n        <span class=\"hljs-keyword\">$this</span>-&gt;_setActiveMenu(<span class=\"hljs-string\">'freaks_quotes'</span>);\n        <span class=\"hljs-keyword\">$this</span>-&gt;_addBreadcrumb(Mage::helper(<span class=\"hljs-string\">'freaks_quotes'</span>)-&gt;__(<span class=\"hljs-string\">'Quotes'</span>), Mage::helper(<span class=\"hljs-string\">'freaks_quotes'</span>)-&gt;__(<span class=\"hljs-string\">'Quotes'</span>));\n        <span class=\"hljs-keyword\">$this</span>-&gt;renderLayout();\n    }\n\n    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">newAction</span><span class=\"hljs-params\">()</span>\n    </span>{\n        <span class=\"hljs-keyword\">$this</span>-&gt;_title(<span class=\"hljs-keyword\">$this</span>-&gt;__(<span class=\"hljs-string\">'Add new quote'</span>));\n        <span class=\"hljs-keyword\">$this</span>-&gt;loadLayout();\n        <span class=\"hljs-keyword\">$this</span>-&gt;_setActiveMenu(<span class=\"hljs-string\">'freaks_quotes'</span>);\n        <span class=\"hljs-keyword\">$this</span>-&gt;_addBreadcrumb(Mage::helper(<span class=\"hljs-string\">'freaks_quotes'</span>)-&gt;__(<span class=\"hljs-string\">'Add new quote'</span>), Mage::helper(<span class=\"hljs-string\">'freaks_quotes'</span>)-&gt;__(<span class=\"hljs-string\">'Add new quote'</span>));\n        <span class=\"hljs-keyword\">$this</span>-&gt;renderLayout();\n    }\n\n    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">editAction</span><span class=\"hljs-params\">()</span>\n    </span>{\n        <span class=\"hljs-keyword\">$this</span>-&gt;_title(<span class=\"hljs-keyword\">$this</span>-&gt;__(<span class=\"hljs-string\">'Edit quote'</span>));\n\n        <span class=\"hljs-keyword\">$this</span>-&gt;loadLayout();\n        <span class=\"hljs-keyword\">$this</span>-&gt;_setActiveMenu(<span class=\"hljs-string\">'freaks_quotes'</span>);\n        <span class=\"hljs-keyword\">$this</span>-&gt;_addBreadcrumb(Mage::helper(<span class=\"hljs-string\">'freaks_quotes'</span>)-&gt;__(<span class=\"hljs-string\">'Edit quote'</span>), Mage::helper(<span class=\"hljs-string\">'freaks_quotes'</span>)-&gt;__(<span class=\"hljs-string\">'Edit Quote'</span>));\n        <span class=\"hljs-keyword\">$this</span>-&gt;renderLayout();\n    }\n\n    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">deleteAction</span><span class=\"hljs-params\">()</span>\n    </span>{\n        $tipId = <span class=\"hljs-keyword\">$this</span>-&gt;getRequest()-&gt;getParam(<span class=\"hljs-string\">'id'</span>, <span class=\"hljs-keyword\">false</span>);\n\n        <span class=\"hljs-keyword\">try</span> {\n            Mage::getModel(<span class=\"hljs-string\">'freaks_quotes/quote'</span>)-&gt;setId($tipId)-&gt;delete();\n            Mage::getSingleton(<span class=\"hljs-string\">'adminhtml/session'</span>)-&gt;addSuccess(Mage::helper(<span class=\"hljs-string\">'freaks_quotes'</span>)-&gt;__(<span class=\"hljs-string\">'Quote successfully deleted'</span>));\n\n            <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">$this</span>-&gt;_redirect(<span class=\"hljs-string\">'*/*/'</span>);\n        } <span class=\"hljs-keyword\">catch</span> (Mage_Core_Exception $e){\n            Mage::getSingleton(<span class=\"hljs-string\">'adminhtml/session'</span>)-&gt;addError($e-&gt;getMessage());\n        } <span class=\"hljs-keyword\">catch</span> (<span class=\"hljs-keyword\">Exception</span> $e) {\n            Mage::logException($e);\n            Mage::getSingleton(<span class=\"hljs-string\">'adminhtml/session'</span>)-&gt;addError(<span class=\"hljs-keyword\">$this</span>-&gt;__(<span class=\"hljs-string\">'Somethings went wrong'</span>));\n        }\n\n        <span class=\"hljs-keyword\">$this</span>-&gt;_redirectReferer();\n    }\n\n    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">saveAction</span><span class=\"hljs-params\">()</span>\n    </span>{\n        $data = <span class=\"hljs-keyword\">$this</span>-&gt;getRequest()-&gt;getPost();\n        <span class=\"hljs-keyword\">if</span> (!<span class=\"hljs-keyword\">empty</span>($data)) {\n            <span class=\"hljs-keyword\">try</span> {\n                Mage::getModel(<span class=\"hljs-string\">'freaks_quotes/quote'</span>)-&gt;setData($data)\n                    -&gt;save();\n                Mage::getSingleton(<span class=\"hljs-string\">'adminhtml/session'</span>)-&gt;addSuccess(Mage::helper(<span class=\"hljs-string\">'freaks_quotes'</span>)-&gt;__(<span class=\"hljs-string\">'Quote successfully saved'</span>));\n            } <span class=\"hljs-keyword\">catch</span> (Mage_Core_Exception $e) {\n                Mage::getSingleton(<span class=\"hljs-string\">'adminhtml/session'</span>)-&gt;addError($e-&gt;getMessage());\n            } <span class=\"hljs-keyword\">catch</span> (<span class=\"hljs-keyword\">Exception</span> $e) {\n                Mage::logException($e);\n                Mage::getSingleton(<span class=\"hljs-string\">'adminhtml/session'</span>)-&gt;addError(<span class=\"hljs-keyword\">$this</span>-&gt;__(<span class=\"hljs-string\">'Somethings went wrong'</span>));\n            }\n        }\n        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">$this</span>-&gt;_redirect(<span class=\"hljs-string\">'*/*/'</span>);\n    }\n\n    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">gridAction</span><span class=\"hljs-params\">()</span>\n    </span>{\n        <span class=\"hljs-keyword\">$this</span>-&gt;loadLayout();\n        <span class=\"hljs-keyword\">$this</span>-&gt;getResponse()-&gt;setBody(\n            <span class=\"hljs-keyword\">$this</span>-&gt;getLayout()-&gt;createBlock(<span class=\"hljs-string\">'freaks_quotes/adminhtml_quotes_grid'</span>)-&gt;toHtml()\n        );\n    }\n}\n</code></pre>\n<p><em>index</em>, <em>new</em>, <em>edit</em> екшены - аналогичные. Я не усложнял код выносом общей логики в в отдельную функцию, потому что я хочу ясно показать что и кто и где делает. Эти методы просто ставят <em>title</em> для страницы, загружают <em>layout</em> объект, устанавливают активное меню и отображают макет.</p>\n<p>Более интересная информация скрыта в методах <em>delete</em>, <em>save</em> и <em>grid</em>.</p>\n<p>Самый простой <em>deleteAction</em> - получает идентификатор цитаты через объект <em>Request,</em> устанавливает его для модели и пытается удалить. Если все произошло успешно добавляем в сессию сообщение об успешном завершении. Если же получаем <em>Mage_Core_Exception</em> - это значит, что он брошен разработчиками и в нем понятный для пользователя текст, поэтому устанавливаем его нотайс в сессию также. При условии что поймалась какая-то другая ошибка, вероятнее всего что это логическая или еще какая-то ошибки, которая понятна только разработчикам. Поэтому вызываем метод <em>logException</em>, который запишет ошибку на файловою систему если это разрешено в <strong>System</strong> &gt; <strong>Developer</strong> &gt; <strong>Log Settings</strong>. И в конце перенаправляем пользователя на страницу с которой он пришел или главную страницу модуля.</p>\n<p><em>saveAction</em> делает аналогичную работу с одним маленьким НО :) он принимает данные с формы и пробует сохранить цитату. Вся остальная процедура повторяется.</p>\n<p><em>gridAction</em> нужен для обработки AJAX запросов на поиск и сортировку даных в таблице. По сути он загружает <em>layout,</em> создает _grid-_блок, который мы создадим чуть позже, превращает блок в <em>html</em> и устанавливает как тело ответа в объект <em>Response</em>.</p>\n<h2 id=\"delaem-vid-chto-rabotaem\"><a name=\"delaem-vid-chto-rabotaem\" class=\"h-link\" href=\"#\"></a>Делаем вид, что работаем</h2>\n<p>Пришло время создать блоки. Хочу сразу обрадовать, нам не придется писать <em>html</em>-код, разработчики Magento, позаботились об этом и спасибо им:)</p>\n<p>Создадим пару классов блоков. Для начала <em>Grid</em> и <em>GridContainer</em> блоки. Открываем <strong>Block/Adminhtml/Quotes.php</strong>, это и будет <em>GridContainer</em></p>\n<pre><code class=\"hljs language-php\"><span class=\"hljs-meta\">&lt;?php</span>\n<span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">Freaks_Quotes_Block_Adminhtml_Quotes</span> <span class=\"hljs-keyword\">extends</span> <span class=\"hljs-title\">Mage_Adminhtml_Block_Widget_Grid_Container</span>\n</span>{\n    <span class=\"hljs-keyword\">protected</span> <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">_construct</span><span class=\"hljs-params\">()</span>\n    </span>{\n        <span class=\"hljs-keyword\">$this</span>-&gt;_addButtonLabel = Mage::helper(<span class=\"hljs-string\">'freaks_quotes'</span>)-&gt;__(<span class=\"hljs-string\">'Add New Quote'</span>);\n\n        <span class=\"hljs-keyword\">$this</span>-&gt;_blockGroup = <span class=\"hljs-string\">'freaks_quotes'</span>;\n        <span class=\"hljs-keyword\">$this</span>-&gt;_controller = <span class=\"hljs-string\">'adminhtml_quotes'</span>;\n        <span class=\"hljs-keyword\">$this</span>-&gt;_headerText = Mage::helper(<span class=\"hljs-string\">'freaks_quotes'</span>)-&gt;__(<span class=\"hljs-string\">'Quotes'</span>);\n    }\n}\n</code></pre>\n<p>Здесь все понятно за исключением того, что свойства объекта <em>_blockGroup</em> и <em>_controller</em> - очень важные. Они задают значения, с помощью которых Magento потом попытается найти <em>Grid</em>-блок. <em>_blockGroup -</em> это просто имя вашего модуля, а контроллер указывает путь (через символ &quot;_&quot;) относительно корня модуля, где лежит ваш <em>Grid.</em> Посмотрев внимательно вначале статьи на структуру директорий, можно увидеть почему здесь именно такие значения. Документацию по методам можно найти <a href=\"http://docs.magentocommerce.com/Mage_Adminhtml/Mage_Adminhtml_Block_Widget_Grid_Container.html\" title=\"Magento документация Grid Container\" target=\"_blank\" rel=\"noopener nofollow\">ЗДЕСЬ</a>.</p>\n<p>Создадим <em>Grid</em>-блок (<strong>Block/Adminhtml/Quotes/Grid.php</strong>)</p>\n<pre><code class=\"hljs language-php\"><span class=\"hljs-meta\">&lt;?php</span>\n<span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">Freaks_Quotes_Block_Adminhtml_Quotes_Grid</span> <span class=\"hljs-keyword\">extends</span> <span class=\"hljs-title\">Mage_Adminhtml_Block_Widget_Grid</span>\n</span>{\n    <span class=\"hljs-keyword\">protected</span> <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">_construct</span><span class=\"hljs-params\">()</span>\n    </span>{\n        <span class=\"hljs-keyword\">$this</span>-&gt;setId(<span class=\"hljs-string\">'quotesGrid'</span>);\n        <span class=\"hljs-keyword\">$this</span>-&gt;_controller = <span class=\"hljs-string\">'adminhtml_quotes'</span>;\n        <span class=\"hljs-keyword\">$this</span>-&gt;setUseAjax(<span class=\"hljs-keyword\">true</span>);\n\n        <span class=\"hljs-keyword\">$this</span>-&gt;setDefaultSort(<span class=\"hljs-string\">'id'</span>);\n        <span class=\"hljs-keyword\">$this</span>-&gt;setDefaultDir(<span class=\"hljs-string\">'desc'</span>);\n    }\n\n    <span class=\"hljs-keyword\">protected</span> <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">_prepareCollection</span><span class=\"hljs-params\">()</span>\n    </span>{\n        $collection = Mage::getModel(<span class=\"hljs-string\">'freaks_quotes/quote'</span>)-&gt;getCollection();\n        <span class=\"hljs-keyword\">$this</span>-&gt;setCollection($collection);\n\n        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">parent</span>::_prepareCollection();\n    }\n\n    <span class=\"hljs-keyword\">protected</span> <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">_prepareColumns</span><span class=\"hljs-params\">()</span>\n    </span>{\n        <span class=\"hljs-keyword\">$this</span>-&gt;addColumn(<span class=\"hljs-string\">'id'</span>, <span class=\"hljs-keyword\">array</span>(\n            <span class=\"hljs-string\">'header'</span>        =&gt; Mage::helper(<span class=\"hljs-string\">'freaks_quotes'</span>)-&gt;__(<span class=\"hljs-string\">'ID'</span>),\n            <span class=\"hljs-string\">'align'</span>         =&gt; <span class=\"hljs-string\">'right'</span>,\n            <span class=\"hljs-string\">'width'</span>         =&gt; <span class=\"hljs-string\">'20px'</span>,\n            <span class=\"hljs-string\">'filter_index'</span>  =&gt; <span class=\"hljs-string\">'id'</span>,\n            <span class=\"hljs-string\">'index'</span>         =&gt; <span class=\"hljs-string\">'id'</span>\n        ));\n\n        <span class=\"hljs-keyword\">$this</span>-&gt;addColumn(<span class=\"hljs-string\">'name'</span>, <span class=\"hljs-keyword\">array</span>(\n            <span class=\"hljs-string\">'header'</span>        =&gt; Mage::helper(<span class=\"hljs-string\">'freaks_quotes'</span>)-&gt;__(<span class=\"hljs-string\">'Title'</span>),\n            <span class=\"hljs-string\">'align'</span>         =&gt; <span class=\"hljs-string\">'left'</span>,\n            <span class=\"hljs-string\">'filter_index'</span>  =&gt; <span class=\"hljs-string\">'name'</span>,\n            <span class=\"hljs-string\">'index'</span>         =&gt; <span class=\"hljs-string\">'name'</span>,\n            <span class=\"hljs-string\">'type'</span>          =&gt; <span class=\"hljs-string\">'text'</span>,\n            <span class=\"hljs-string\">'truncate'</span>      =&gt; <span class=\"hljs-number\">50</span>,\n            <span class=\"hljs-string\">'escape'</span>        =&gt; <span class=\"hljs-keyword\">true</span>,\n        ));\n\n        <span class=\"hljs-keyword\">$this</span>-&gt;addColumn(<span class=\"hljs-string\">'action'</span>, <span class=\"hljs-keyword\">array</span>(\n            <span class=\"hljs-string\">'header'</span>    =&gt; Mage::helper(<span class=\"hljs-string\">'freaks_quotes'</span>)-&gt;__(<span class=\"hljs-string\">'Action'</span>),\n            <span class=\"hljs-string\">'width'</span>     =&gt; <span class=\"hljs-string\">'50px'</span>,\n            <span class=\"hljs-string\">'type'</span>      =&gt; <span class=\"hljs-string\">'action'</span>,\n            <span class=\"hljs-string\">'getter'</span>     =&gt; <span class=\"hljs-string\">'getId'</span>,\n            <span class=\"hljs-string\">'actions'</span>   =&gt; <span class=\"hljs-keyword\">array</span>(\n                <span class=\"hljs-keyword\">array</span>(\n                    <span class=\"hljs-string\">'caption'</span> =&gt; Mage::helper(<span class=\"hljs-string\">'freaks_quotes'</span>)-&gt;__(<span class=\"hljs-string\">'Edit'</span>),\n                    <span class=\"hljs-string\">'url'</span>     =&gt; <span class=\"hljs-keyword\">array</span>(\n                        <span class=\"hljs-string\">'base'</span>=&gt;<span class=\"hljs-string\">'*/*/edit'</span>,\n                    ),\n                    <span class=\"hljs-string\">'field'</span>   =&gt; <span class=\"hljs-string\">'id'</span>\n                )\n            ),\n            <span class=\"hljs-string\">'filter'</span>    =&gt; <span class=\"hljs-keyword\">false</span>,\n            <span class=\"hljs-string\">'sortable'</span>  =&gt; <span class=\"hljs-keyword\">false</span>,\n            <span class=\"hljs-string\">'index'</span>     =&gt; <span class=\"hljs-string\">'id'</span>,\n        ));\n\n        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">parent</span>::_prepareColumns();\n    }\n\n    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">getRowUrl</span><span class=\"hljs-params\">($quote)</span>\n    </span>{\n        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">$this</span>-&gt;getUrl(<span class=\"hljs-string\">'*/*/edit'</span>, <span class=\"hljs-keyword\">array</span>(\n            <span class=\"hljs-string\">'id'</span> =&gt; $quote-&gt;getId(),\n        ));\n    }\n\n    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">getGridUrl</span><span class=\"hljs-params\">()</span>\n    </span>{\n        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">$this</span>-&gt;getUrl(<span class=\"hljs-string\">'*/*/grid'</span>, <span class=\"hljs-keyword\">array</span>(<span class=\"hljs-string\">'_current'</span>=&gt;<span class=\"hljs-keyword\">true</span>));\n    }\n}\n</code></pre>\n<p>Здесь в конструкторе указываем некоторые параметры, такие как: сортировка по умолчанию, идентификатор grid-а в html, использование AJAX технологии.</p>\n<p><em>_prepareCollection -</em> подготавливаем коллекцию объектов которые нужно отображать. В нашем случае, просто берем объект коллекции для цитат и передаем его в <em>Grid.</em></p>\n<p><em>_prepareColumns</em> - в этом методе создаем колонки для таблицы. Для каждого типа колонки есть свой <em>renderer</em> в <strong>app/code/core/Mage/Adminhtml/Block/Widget/Grid/Column/Renderer</strong>. Рассмотрим метод <em>addColumn</em>. Первый параметр метода - это идентификатор колонки, второй настройки ее отображения. В зависимости от _renderer-_а их может быть больше или меньше, поэтому рассмотрим только базовые, если хотите знать больше, то Вам <a href=\"http://docs.magentocommerce.com/Mage_Adminhtml/Mage_Adminhtml_Block_Widget_Grid.html#addColumn\" title=\"Magento документация Grid::addColumn\" target=\"_blank\" rel=\"noopener nofollow\">СЮДА</a>.</p>\n<ul>\n<li><em>header</em> - название колонки в таблице, отображается пользователю</li>\n<li><em>align</em> - позиционирование текста в колонке</li>\n<li><em>filter_index</em> - индекс значения в объекте по-которому будет производится поиск в коллекции</li>\n<li><em>index</em> - индекс значения объекта, который нужно вывести в каждой строке этой колонки</li>\n<li><em>type</em> - задает <em>renderer</em></li>\n<li><em>truncate</em> - к-во символов, которые нужно выводить</li>\n<li><em>sortable</em> - указывает можно ли делать сортировку по колонке</li>\n<li><em>filter</em> - указывает можно ли делать поиск по колонке</li>\n<li><em>width</em> - указывает ширину</li>\n<li><em>escape</em> - вызывает метод htmlEscape для значения</li>\n</ul>\n<p><em>getRowUrl -</em> возвращает URL для редактирования цитаты.</p>\n<p><em>getGridUrl -</em> возвращает URL, на который нужно отправлять AJAX запросы.</p>\n<p>Ну вот можете зайти на свой модуль и увидить очень даже симпотичную таблицу</p>\n<p><img src=\"/media/assets/magento-backend-module.jpg\" alt=\"\" title=\"Custom module Magento - просмотр цитат. Grid\" loading=\"lazy\" width=\"1172\" style=\"max-height: 704px;\" srcset=\"/media/assets/magento-backend-module-xs.jpg 375w,/media/assets/magento-backend-module-sm.jpg 768w,/media/assets/magento-backend-module-md.jpg 1024w,/media/assets/magento-backend-module.jpg 1280w\" sizes=\"(max-width: 375px) 375px,(max-width: 768px) 768px,(max-width: 1024px) 1024px,1280px\"></p>\n<p>Теперь создадим блоки отвечающие за редактирование и создание цитат. Используем только одну форму для этих действий. Открываем <strong>Block/Adminhtml/Edit.php</strong></p>\n<pre><code class=\"hljs language-php\"><span class=\"hljs-meta\">&lt;?php</span>\n<span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">Freaks_Quotes_Block_Adminhtml_Edit</span> <span class=\"hljs-keyword\">extends</span> <span class=\"hljs-title\">Mage_Adminhtml_Block_Widget_Form_Container</span>\n</span>{\n    <span class=\"hljs-keyword\">protected</span> <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">_construct</span><span class=\"hljs-params\">()</span>\n    </span>{\n        <span class=\"hljs-keyword\">$this</span>-&gt;_blockGroup = <span class=\"hljs-string\">'freaks_quotes'</span>;\n        <span class=\"hljs-keyword\">$this</span>-&gt;_mode = <span class=\"hljs-string\">'edit'</span>;\n        <span class=\"hljs-keyword\">$this</span>-&gt;_controller = <span class=\"hljs-string\">'adminhtml'</span>;\n\n        $quote_id = (int)<span class=\"hljs-keyword\">$this</span>-&gt;getRequest()-&gt;getParam(<span class=\"hljs-keyword\">$this</span>-&gt;_objectId);\n        $quote = Mage::getModel(<span class=\"hljs-string\">'freaks_quotes/quote'</span>)-&gt;load($quote_id);\n        Mage::register(<span class=\"hljs-string\">'current_quote'</span>, $quote);\n    }\n\n    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">getHeaderText</span><span class=\"hljs-params\">()</span>\n    </span>{\n        $quote = Mage::registry(<span class=\"hljs-string\">'current_quote'</span>);\n        <span class=\"hljs-keyword\">if</span> ($quote-&gt;getId()) {\n            <span class=\"hljs-keyword\">return</span> Mage::helper(<span class=\"hljs-string\">'freaks_quotes'</span>)-&gt;__(<span class=\"hljs-string\">\"Edit Quote '%s'\"</span>, <span class=\"hljs-keyword\">$this</span>-&gt;escapeHtml($quote-&gt;getName()));\n        } <span class=\"hljs-keyword\">else</span> {\n            <span class=\"hljs-keyword\">return</span> Mage::helper(<span class=\"hljs-string\">'freaks_quotes'</span>)-&gt;__(<span class=\"hljs-string\">\"Add new Quote\"</span>);\n        }\n    }\n}\n</code></pre>\n<p>Разбираем, что же здесь происходит... <em>Form_Container</em> по аналогии к <em>Grid_Container</em>-у будет искать класс формы с учетом <em>_blockGroup</em>, <em>_mode</em> и <em>_controller.</em> Единственная разница - это свойство <em>_mode.</em> Имя класса формы будет формироваться следующим образом:</p>\n<pre><code class=\"hljs language-php\">$layout-&gt;createBlock(<span class=\"hljs-keyword\">$this</span>-&gt;_blockGroup . <span class=\"hljs-string\">'/'</span> . <span class=\"hljs-keyword\">$this</span>-&gt;_controller . <span class=\"hljs-string\">'_'</span> . <span class=\"hljs-keyword\">$this</span>-&gt;_mode . <span class=\"hljs-string\">'_form'</span>)\n</code></pre>\n<p>Поэтому здесь нужно быть особо внимательным. Если у Вас что-то не работает, скорее всего проблема именно здесь.</p>\n<p>Потом берем идентификатор цитаты в запросе загружаем модель и добавляем ее в Magento реестр (реестр - это просто статической свойство в класса Mage, которое является массивом объектов и используется для передачи объектов между классами никак не связаными). Это нужно, чтобы потом обратится к этой цитате в объекте формы. Метод <em>getHeaderText</em> - просто выводит заголовок для екшена в зависимости от того добавляется цитата или редактируется.</p>\n<p>Создаем класс формы (<strong>Block/Adminhtml/Edit/Form.php</strong>)</p>\n<pre><code class=\"hljs language-php\"><span class=\"hljs-meta\">&lt;?php</span>\n<span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">Freaks_Quotes_Block_Adminhtml_Edit_Form</span> <span class=\"hljs-keyword\">extends</span> <span class=\"hljs-title\">Mage_Adminhtml_Block_Widget_Form</span>\n</span>{\n    <span class=\"hljs-keyword\">protected</span> <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">_prepareForm</span><span class=\"hljs-params\">()</span>\n    </span>{\n        $quote = Mage::registry(<span class=\"hljs-string\">'current_quote'</span>);\n        $form = <span class=\"hljs-keyword\">new</span> Varien_Data_Form();\n        $fieldset = $form-&gt;addFieldset(<span class=\"hljs-string\">'edit_quote'</span>, <span class=\"hljs-keyword\">array</span>(\n            <span class=\"hljs-string\">'legend'</span> =&gt; Mage::helper(<span class=\"hljs-string\">'freaks_quotes'</span>)-&gt;__(<span class=\"hljs-string\">'Quote Details'</span>)\n        ));\n\n        <span class=\"hljs-keyword\">if</span> ($quote-&gt;getId()) {\n            $fieldset-&gt;addField(<span class=\"hljs-string\">'id'</span>, <span class=\"hljs-string\">'hidden'</span>, <span class=\"hljs-keyword\">array</span>(\n                <span class=\"hljs-string\">'name'</span>      =&gt; <span class=\"hljs-string\">'id'</span>,\n                <span class=\"hljs-string\">'required'</span>  =&gt; <span class=\"hljs-keyword\">true</span>\n            ));\n        }\n\n        $fieldset-&gt;addField(<span class=\"hljs-string\">'name'</span>, <span class=\"hljs-string\">'text'</span>, <span class=\"hljs-keyword\">array</span>(\n            <span class=\"hljs-string\">'name'</span>      =&gt; <span class=\"hljs-string\">'name'</span>,\n            <span class=\"hljs-string\">'label'</span>     =&gt; Mage::helper(<span class=\"hljs-string\">'freaks_quotes'</span>)-&gt;__(<span class=\"hljs-string\">'Title'</span>),\n            <span class=\"hljs-string\">'maxlength'</span> =&gt; <span class=\"hljs-string\">'250'</span>,\n            <span class=\"hljs-string\">'required'</span>  =&gt; <span class=\"hljs-keyword\">true</span>,\n        ));\n\n        $fieldset-&gt;addField(<span class=\"hljs-string\">'dscr'</span>, <span class=\"hljs-string\">'textarea'</span>, <span class=\"hljs-keyword\">array</span>(\n            <span class=\"hljs-string\">'name'</span>      =&gt; <span class=\"hljs-string\">'dscr'</span>,\n            <span class=\"hljs-string\">'label'</span>     =&gt; Mage::helper(<span class=\"hljs-string\">'freaks_quotes'</span>)-&gt;__(<span class=\"hljs-string\">'Contents'</span>),\n            <span class=\"hljs-string\">'style'</span>     =&gt; <span class=\"hljs-string\">'width: 98%; height: 200px;'</span>,\n            <span class=\"hljs-string\">'required'</span>  =&gt; <span class=\"hljs-keyword\">true</span>,\n        ));\n\n        $form-&gt;setMethod(<span class=\"hljs-string\">'post'</span>);\n        $form-&gt;setUseContainer(<span class=\"hljs-keyword\">true</span>);\n        $form-&gt;setId(<span class=\"hljs-string\">'edit_form'</span>);\n        $form-&gt;setAction(<span class=\"hljs-keyword\">$this</span>-&gt;getUrl(<span class=\"hljs-string\">'*/*/save'</span>));\n        $form-&gt;setValues($quote-&gt;getData());\n\n        <span class=\"hljs-keyword\">$this</span>-&gt;setForm($form);\n    }\n}\n</code></pre>\n<p>Метод <em>_prepareForm</em> подготавливает форму для отображения. Посмотрим, что там происходит... Берем нашу цитату из реестра, создаем объект <em>Varien_Data_Form</em>, добавляем к нему один <em>fieldset</em> (в контексте данной разработки больше не нужно, но можно добавить и больше) и поля в него. Если это создание новой цитаты, тогда нам аоле <em>id</em> не нужно, учитываем это. Передаем значения у форму методом <em>setValues.</em> Все остальное достаточно логично и понятно из самомого кода.</p>\n<p><img src=\"/media/assets/magento-backend-module-edit.jpg\" alt=\"\" title=\"Magento документация Form Container\" loading=\"lazy\" width=\"1172\" style=\"max-height: 715px;\" srcset=\"/media/assets/magento-backend-module-edit-xs.jpg 375w,/media/assets/magento-backend-module-edit-sm.jpg 768w,/media/assets/magento-backend-module-edit-md.jpg 1024w,/media/assets/magento-backend-module-edit.jpg 1280w\" sizes=\"(max-width: 375px) 375px,(max-width: 768px) 768px,(max-width: 1024px) 1024px,1280px\"></p>\n<p>Ну вот создание модуля завершено, можете наслаждатся добавлением цитат :) Готовый вариант можно скачать <a href=\"/media/assets/Freak_Quotes_All.zip\" title=\"Magento custom module download\" download=\"Freak_Quotes_All.zip\">ЗДЕСЬ</a>.</p>\n<p>В следующей статье я опишу, как создать атрибут quote для продукта и каким образом связать его з цитатой.</p>","headings":[["rekonfiguring","Реконфигуринг"],["kontroliruem","Контролируем"],["delaem-vid-chto-rabotaem","Делаем вид, что работаем"]],"id":"magento-backend-sozdanie-crud-modulya"}