{"title":"Magento backend - грузим картинку через админку","summary":"Ну вот по просьбе одного из читателей блога, я решил сначала добавить\nвозможность загрузки картинки для модуля Freaks_Quotes. Итак...\n","author":"sstotskyi","categories":["backend"],"createdAt":"2011-02-11T10:53:00.000Z","meta":{"keywords":["magento","backend","загрузка картинки"]},"alias":"magento-backend---gruzim-kartinku-cherez-adminku","content":"<p>Если кто-то пропустил предыдущие главы, то модуль для дальнейшей работы можно скачать <a href=\"/media/assets/Freak_Quotes_All.zip\" download=\"Freak_Quotes_All.zip\">ЗДЕСЬ</a>.</p>\n<p>Итак для начала нужно написать mysql-upgrade для нашего модуля, чтобы добавить поле в котором будет сохраняться путь к файлу. Создаем <strong>app/code/local/Freaks/Quotes/sql/quotes_setup/mysql4-upgrade-0.2.0-0.3.0.php</strong></p>\n<pre><code class=\"hljs language-php\"><span class=\"hljs-meta\">&lt;?php</span>\n$installer = <span class=\"hljs-keyword\">$this</span>;\n$installer-&gt;startSetup();\n\n$installer-&gt;run(<span class=\"hljs-string\">\"\nALTER TABLE `{$this-&gt;getTable('freaks_quotes/quote')}` ADD `image` VARCHAR( 255 ) NOT NULL\n\"</span>);\n \n$installer-&gt;endSetup();\n</code></pre>\n<p>ВНИМАНИЕ!!! Не забываем сменить версию нашего в модуля в <strong>config.xml</strong>, иначе upgrade не запустится!!!</p>\n<h2 id=\"krutim-pedali\"><a name=\"krutim-pedali\" class=\"h-link\" href=\"#\"></a>Крутим педали</h2>\n<p>Открываем теперь файл формы (<strong>app/code/local/Freaks/Quotes/Block/Adminhtml/Edit/Form.php</strong>) и добавляем новое поле с типом <em>image</em></p>\n<pre><code class=\"hljs language-php\"><span class=\"hljs-meta\">&lt;?php</span>\n<span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">Freaks_Quotes_Block_Adminhtml_Edit_Form</span> <span class=\"hljs-keyword\">extends</span> <span class=\"hljs-title\">Mage_Adminhtml_Block_Widget_Form</span>\n</span>{\n    <span class=\"hljs-keyword\">protected</span> <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">_prepareForm</span><span class=\"hljs-params\">()</span>\n    </span>{\n        $quote = Mage::registry(<span class=\"hljs-string\">'current_quote'</span>);\n        $form = <span class=\"hljs-keyword\">new</span> Varien_Data_Form(<span class=\"hljs-keyword\">array</span>(\n            <span class=\"hljs-string\">'enctype'</span>=&gt; <span class=\"hljs-string\">'multipart/form-data'</span>\n        ));\n        $fieldset = $form-&gt;addFieldset(<span class=\"hljs-string\">'edit_quote'</span>, <span class=\"hljs-keyword\">array</span>(\n            <span class=\"hljs-string\">'legend'</span> =&gt; Mage::helper(<span class=\"hljs-string\">'freaks_quotes'</span>)-&gt;__(<span class=\"hljs-string\">'Quote Details'</span>)\n        ));\n\n        <span class=\"hljs-keyword\">if</span> ($quote-&gt;getId()) {\n            $fieldset-&gt;addField(<span class=\"hljs-string\">'id'</span>, <span class=\"hljs-string\">'hidden'</span>, <span class=\"hljs-keyword\">array</span>(\n                <span class=\"hljs-string\">'name'</span>      =&gt; <span class=\"hljs-string\">'id'</span>,\n                <span class=\"hljs-string\">'required'</span>  =&gt; <span class=\"hljs-keyword\">true</span>\n            ));\n        }\n \n        $fieldset-&gt;addField(<span class=\"hljs-string\">'name'</span>, <span class=\"hljs-string\">'text'</span>, <span class=\"hljs-keyword\">array</span>(\n            <span class=\"hljs-string\">'name'</span>      =&gt; <span class=\"hljs-string\">'name'</span>,\n            <span class=\"hljs-string\">'title'</span>     =&gt; Mage::helper(<span class=\"hljs-string\">'freaks_quotes'</span>)-&gt;__(<span class=\"hljs-string\">'Title'</span>),\n            <span class=\"hljs-string\">'label'</span>     =&gt; Mage::helper(<span class=\"hljs-string\">'freaks_quotes'</span>)-&gt;__(<span class=\"hljs-string\">'Title'</span>),\n            <span class=\"hljs-string\">'maxlength'</span> =&gt; <span class=\"hljs-string\">'250'</span>,\n            <span class=\"hljs-string\">'required'</span>  =&gt; <span class=\"hljs-keyword\">true</span>,\n        ));\n        \n        $fieldset-&gt;addField(<span class=\"hljs-string\">'dscr'</span>, <span class=\"hljs-string\">'textarea'</span>, <span class=\"hljs-keyword\">array</span>(\n            <span class=\"hljs-string\">'name'</span>      =&gt; <span class=\"hljs-string\">'dscr'</span>,\n            <span class=\"hljs-string\">'title'</span>     =&gt; Mage::helper(<span class=\"hljs-string\">'freaks_quotes'</span>)-&gt;__(<span class=\"hljs-string\">'Contents'</span>),\n            <span class=\"hljs-string\">'label'</span>     =&gt; Mage::helper(<span class=\"hljs-string\">'freaks_quotes'</span>)-&gt;__(<span class=\"hljs-string\">'Contents'</span>),\n            <span class=\"hljs-string\">'style'</span>     =&gt; <span class=\"hljs-string\">'width: 98%; height: 200px;'</span>,\n            <span class=\"hljs-string\">'required'</span>  =&gt; <span class=\"hljs-keyword\">true</span>,\n        ));\n \n        $fieldset-&gt;addField(<span class=\"hljs-string\">'image'</span>, <span class=\"hljs-string\">'image'</span>, <span class=\"hljs-keyword\">array</span>(\n            <span class=\"hljs-string\">'name'</span>      =&gt; <span class=\"hljs-string\">'image'</span>,\n            <span class=\"hljs-string\">'label'</span>     =&gt; Mage::helper(<span class=\"hljs-string\">'freaks_quotes'</span>)-&gt;__(<span class=\"hljs-string\">'Image'</span>)\n        ));\n \n \t$form-&gt;setMethod(<span class=\"hljs-string\">'post'</span>);\n        $form-&gt;setUseContainer(<span class=\"hljs-keyword\">true</span>);\n        $form-&gt;setId(<span class=\"hljs-string\">'edit_form'</span>);\n        $form-&gt;setAction(<span class=\"hljs-keyword\">$this</span>-&gt;getUrl(<span class=\"hljs-string\">'*/*/save'</span>));\n        \n        $data = $quote-&gt;getData();\n        $data[<span class=\"hljs-string\">'image'</span>] = $quote-&gt;getImage();\n        $form-&gt;setValues($data);\n \n        <span class=\"hljs-keyword\">$this</span>-&gt;setForm($form);\n    }\n}\n</code></pre>\n<p>Меняем модель (<strong>app/code/local/Freaks/Quotes/Model/Quote.php</strong>), чтобы он умел сохранять рисунок на файловую систему в папку <strong>media</strong>.</p>\n<pre><code class=\"hljs language-php\"><span class=\"hljs-meta\">&lt;?php</span>\n<span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">Freaks_Quotes_Model_Quote</span> <span class=\"hljs-keyword\">extends</span> <span class=\"hljs-title\">Mage_Core_Model_Abstract</span>\n</span>{\n    <span class=\"hljs-keyword\">protected</span> $imagePath = <span class=\"hljs-string\">'freaks_quotes'</span>;\n \n    <span class=\"hljs-keyword\">protected</span> <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">_construct</span><span class=\"hljs-params\">()</span>\n    </span>{\n        <span class=\"hljs-keyword\">$this</span>-&gt;_init(<span class=\"hljs-string\">'freaks_quotes/quote'</span>);\n    }\n    \n    <span class=\"hljs-keyword\">protected</span> <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">_beforeSave</span><span class=\"hljs-params\">()</span>\n    </span>{\n        <span class=\"hljs-keyword\">if</span> (<span class=\"hljs-keyword\">$this</span>-&gt;getData(<span class=\"hljs-string\">'image/delete'</span>)) {\n            <span class=\"hljs-keyword\">$this</span>-&gt;unsImage();\n        }\n        <span class=\"hljs-keyword\">try</span> {\n            $uploader = <span class=\"hljs-keyword\">new</span> Varien_File_Uploader(<span class=\"hljs-string\">'image'</span>);\n            $uploader-&gt;setAllowedExtensions(<span class=\"hljs-keyword\">array</span>(<span class=\"hljs-string\">'jpg'</span>,<span class=\"hljs-string\">'jpeg'</span>,<span class=\"hljs-string\">'gif'</span>,<span class=\"hljs-string\">'png'</span>));\n            $uploader-&gt;setAllowRenameFiles(<span class=\"hljs-keyword\">true</span>);\n            \n            <span class=\"hljs-keyword\">$this</span>-&gt;setImage($uploader);\n        } <span class=\"hljs-keyword\">catch</span> (<span class=\"hljs-keyword\">Exception</span> $e) {\n            <span class=\"hljs-comment\">// it means that we do not have files for uploading</span>\n        }\n        \n        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">parent</span>::_beforeSave();\n    }\n    \n    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">getImagePath</span><span class=\"hljs-params\">()</span>\n    </span>{\n        <span class=\"hljs-keyword\">return</span> Mage::getBaseDir(<span class=\"hljs-string\">'media'</span>) . DS . <span class=\"hljs-keyword\">$this</span>-&gt;imagePath . DS;\n    }\n    \n    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">setImage</span><span class=\"hljs-params\">($image)</span>\n    </span>{\n        <span class=\"hljs-keyword\">if</span> ($image <span class=\"hljs-keyword\">instanceof</span> Varien_File_Uploader) {\n            $image-&gt;save(<span class=\"hljs-keyword\">$this</span>-&gt;getImagePath());\n            $image = $image-&gt;getUploadedFileName();\n        }\n        <span class=\"hljs-keyword\">$this</span>-&gt;setData(<span class=\"hljs-string\">'image'</span>, $image);\n        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">$this</span>;\n    }\n    \n    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">getImage</span><span class=\"hljs-params\">()</span>\n    </span>{\n        <span class=\"hljs-keyword\">if</span> ($image = <span class=\"hljs-keyword\">$this</span>-&gt;getData(<span class=\"hljs-string\">'image'</span>)) {\n            <span class=\"hljs-keyword\">return</span> Mage::getBaseUrl(<span class=\"hljs-string\">'media'</span>) . <span class=\"hljs-keyword\">$this</span>-&gt;imagePath . DS . $image;\n        } <span class=\"hljs-keyword\">else</span> {\n            <span class=\"hljs-keyword\">return</span> <span class=\"hljs-string\">''</span>;\n        }\n    }\n    \n    <span class=\"hljs-keyword\">protected</span> <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">prepareImageForDelete</span><span class=\"hljs-params\">()</span>\n    </span>{\n        $image = <span class=\"hljs-keyword\">$this</span>-&gt;getData(<span class=\"hljs-string\">'image'</span>);\n        <span class=\"hljs-keyword\">return</span> str_replace(Mage::getBaseUrl(<span class=\"hljs-string\">'media'</span>), Mage::getBaseDir(<span class=\"hljs-string\">'media'</span>) . DS, $image[<span class=\"hljs-string\">'value'</span>]);\n    }\n    \n    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">unsImage</span><span class=\"hljs-params\">()</span>\n    </span>{\n        $image = <span class=\"hljs-keyword\">$this</span>-&gt;getData(<span class=\"hljs-string\">'image'</span>);\n        <span class=\"hljs-keyword\">if</span> (is_array($image)) {\n            $image = <span class=\"hljs-keyword\">$this</span>-&gt;prepareImageForDelete();\n        } <span class=\"hljs-keyword\">else</span> {\n            $image = <span class=\"hljs-keyword\">$this</span>-&gt;getImagePath() . $image;\n        }\n        \n        <span class=\"hljs-keyword\">if</span> (file_exists($image)) {\n            unlink($image);\n        }\n        <span class=\"hljs-keyword\">$this</span>-&gt;setData(<span class=\"hljs-string\">'image'</span>, <span class=\"hljs-string\">''</span>);\n        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">$this</span>;\n    }\n}\n</code></pre>\n<p>Сначала переопределим метод <em>_beforeSave</em> модели, в котором будем сохранять или удалять картинку. Чтобы сохранить загружаемый пользователем файл, используем стандартный <em>Varien_File_Uploader,</em> в конструктор которого передаем ключ файла из массива <em>$_FILES</em> (если передать ключ, которого не существует в супер глобальной переменной <em>$_FILES</em>, то будет брошено исключение). Он сделает всю грязную работу за нас.</p>\n<p>Рассмотрим теперь методы <em>unsImage</em> и <em>setImage</em>.</p>\n<ul>\n<li><em>setImage -</em> проверяет, если передаваемое значение является объектом класса <em>Varien_File_Uploader</em>, если да - сохраняет его на файловую систему в нужную нам директорию и устанавливает значение в модель</li>\n<li><em>unsImage -</em> проверяет, если значение в модели является массивом, если да - это значит данные были переданы из формы, поэтому заменяем <strong>media base url</strong> на <strong>media base path</strong>. Проверяем если файл существует, то удаляем его</li>\n</ul>\n<p>Вот и все, так просто!!!</p>\n<p>Скачать модифицированый модуль можно <a href=\"/media/assets/Freak_Quotes_With_Image.zip\" download=\"Freak_Quotes_With_Image.zip\">ЗДЕСЬ</a></p>","headings":[["krutim-pedali","Крутим педали"]],"id":"magento-backend-gruzim-kartinku-cherez-adminku"}