{"id":"magento-sozdanie-crud-modulya","title":"Magento - создание CRUD модуля","summary":"Эта статья является первой в серии статей о Magento - одна из самых сложных\nдля программиста платформ. Но это только на первый взгляд. Я опровергну это на\nпримере создания CRUD модуля цитат.\n","author":"sstotskyi","categories":["backend","important"],"createdAt":"2011-01-29T12:56:00.000Z","meta":{"keywords":["magento","crud","модуль"]},"alias":"magento---sozdanie-crud-modulya","content":"<p>Magento - это одна из самых сложных для программиста платформ. Но это только на первый взгляд. В следующих нескольких статьях я опровергну это на примере создания CRUD модуля цитат! Итак поехали :)</p>\n<h2 id=\"nachalo\"><a name=\"nachalo\" class=\"h-link\" href=\"#\"></a>Начало</h2>\n<p>Создадим структуру директорий и файлов для нашего модуля</p>\n<pre><code class=\"hljs language-bash\">|-app\n|---code\n|-----<span class=\"hljs-built_in\">local</span>\n|-------Freaks\n|---------Quotes\n|-----------Block\n|-------------Content.php\n|-----------controllers\n|-------------IndexController.php\n|-----------etc\n|-------------config.xml\n|-----------Model\n|---design\n|-----frontend\n|-------base\n|---------default\n|-----------layout\n|-------------freaks\n|---------------quotes.xml\n|---etc\n|-----modules\n|-------Freaks_All.xml\n</code></pre>\n<p>Создаем файл <strong>config.xml</strong></p>\n<pre><code class=\"hljs language-xml\"><span class=\"hljs-meta\">&lt;?xml version=\"1.0\"?&gt;</span>\n<span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">config</span>&gt;</span>\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">modules</span>&gt;</span>\n        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">Freaks_Quotes</span>&gt;</span>\n            <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">version</span>&gt;</span>0.1.0<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">version</span>&gt;</span>\n        <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">Freaks_Quotes</span>&gt;</span>\n    <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">modules</span>&gt;</span>\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">global</span>&gt;</span>\n        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">blocks</span>&gt;</span>\n            <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">freaks_quotes</span>&gt;</span>\n                <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">class</span>&gt;</span>Freaks_Quotes_Block<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">class</span>&gt;</span>\n            <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">freaks_quotes</span>&gt;</span>\n        <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">blocks</span>&gt;</span>\n    <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">global</span>&gt;</span>\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">frontend</span>&gt;</span>\n        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">routers</span>&gt;</span>\n            <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">Freaks_Quotes</span>&gt;</span>\n                <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">use</span>&gt;</span>standard<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">use</span>&gt;</span>\n                <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">args</span>&gt;</span>\n                    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">module</span>&gt;</span>Freaks_Quotes<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">module</span>&gt;</span>\n                    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">frontName</span>&gt;</span>quotes<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">frontName</span>&gt;</span>\n                <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">args</span>&gt;</span>\n            <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">Freaks_Quotes</span>&gt;</span>\n        <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">routers</span>&gt;</span>\n        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">layout</span>&gt;</span>\n            <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">updates</span>&gt;</span>\n                <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">freaks_quotes</span>&gt;</span>\n                    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">file</span>&gt;</span>freaks/quotes.xml<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">file</span>&gt;</span>\n                <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">freaks_quotes</span>&gt;</span>\n            <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">updates</span>&gt;</span>\n        <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">layout</span>&gt;</span>\n    <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">frontend</span>&gt;</span>\n<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">config</span>&gt;</span>\n</code></pre>\n<p>Немного объясню что это все значит:</p>\n<ul>\n<li>секция <em>modules</em> отвечают за версию вашего модуля. Это нужно, чтобы потом можно было обновить модуль, когда будет выпущена новая версия</li>\n<li><em>blocks</em> - указывает движку, где находятся блоки для отображения (по своей сути Magento отображает весь контент у виде вложеных блоков, что-то похожее на <a href=\"http://drupal.org/\" target=\"_blank\" rel=\"noopener nofollow\"><em>Drupal</em></a>, если кто-то сталкивался)</li>\n<li><em>frontend/routes</em> - указываем <em>routing</em>, наш модуль на frontend-е будет доступен по адресу &quot;/quotes&quot;</li>\n<li><em>frontend/layout/updates</em> - указывает, какой файл отвечает за изменение макета, когда наш модуль включен</li>\n</ul>\n<p>Чтобы модуль можно было начать тестировать, нужно для начала его включить. Открываем файл <strong>app/etc/modules/Freaks_All.xml</strong></p>\n<pre><code class=\"hljs language-xml\"><span class=\"hljs-meta\">&lt;?xml version=\"1.0\"?&gt;</span>\n<span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">config</span>&gt;</span>\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">modules</span>&gt;</span>\n        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">Freaks_Quotes</span>&gt;</span>\n            <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">active</span>&gt;</span>true<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">active</span>&gt;</span>\n            <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">codePool</span>&gt;</span>local<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">codePool</span>&gt;</span>\n        <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">Freaks_Quotes</span>&gt;</span>\n    <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">modules</span>&gt;</span>\n<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">config</span>&gt;</span>\n</code></pre>\n<p>Открываем файл <strong>app/design/frontend/base/default/layout/freaks/quotes.xml</strong>. Это layout-файл, который отвечает за отображение блоков при запросе пользователя.</p>\n<pre><code class=\"hljs language-xml\"><span class=\"hljs-meta\">&lt;?xml version=\"1.0\"?&gt;</span>\n<span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">layout</span> <span class=\"hljs-attr\">version</span>=<span class=\"hljs-string\">\"0.1.0\"</span>&gt;</span>\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">freaks_quotes_index_index</span>&gt;</span>\n        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">reference</span> <span class=\"hljs-attr\">name</span>=<span class=\"hljs-string\">\"content\"</span>&gt;</span>\n            <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">block</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"freaks_quotes/content\"</span> <span class=\"hljs-attr\">name</span>=<span class=\"hljs-string\">\"quotes.all\"</span> /&gt;</span>\n        <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">reference</span>&gt;</span>\n    <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">freaks_quotes_index_index</span>&gt;</span>\n<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">layout</span>&gt;</span>\n</code></pre>\n<p><em>freaks_quotes_index_index</em> - это один из <em>handle</em>-ов, которые генерирует Magento, когда открывается страница. В нашем случае мы говорим, что когда в нас модуль = freaks_quotes, контроллер = index и действие = index, тогда обращаемся к блоку контент посредством директивы <em>reference</em> и добавляем в него новый блок, который мы создали.</p>\n<p>Теперь создаем контроллер, в нашем случае он очень простой, так как все что нужно сделать описано в layout файле.</p>\n<pre><code class=\"hljs language-php\"><span class=\"hljs-meta\">&lt;?php</span>\n<span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">Freaks_Quotes_IndexController</span> <span class=\"hljs-keyword\">extends</span> <span class=\"hljs-title\">Mage_Core_Controller_Front_Action</span>\n</span>{\n    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">indexAction</span><span class=\"hljs-params\">()</span>\n    </span>{\n        <span class=\"hljs-keyword\">$this</span>-&gt;loadLayout()\n            -&gt;renderLayout();\n    }\n}\n</code></pre>\n<p>Создадим блок, который будет выводит наш контент. Для тестирования просто выведем название нашего модуля</p>\n<pre><code class=\"hljs language-php\"><span class=\"hljs-meta\">&lt;?php</span>\n<span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">Freaks_Quotes_Block_Content</span> <span class=\"hljs-keyword\">extends</span> <span class=\"hljs-title\">Mage_Core_Block_Template</span>\n</span>{\n    <span class=\"hljs-keyword\">protected</span> <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">_toHtml</span><span class=\"hljs-params\">()</span>\n    </span>{\n        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-string\">'Freaks_Quotes'</span>;\n    }\n}\n</code></pre>\n<p>И последнее - заходим в панель администратора и там <strong>System</strong> &gt; <strong>Configuration</strong> &gt; <strong>Advanced</strong> &gt; <strong>Advanced</strong> . Нажимаем кнопку <strong>Save Config</strong> (это нужно, чтобы разрешить выводить контент на сайте для нашего модуля.). Чистим кэш и заходим на нашу страничку цитат. На моем локальном компьютере - это http://mage.linux/quotes.</p>\n<p>Если все работает я Вас поздравляю, если нет можете написать мне на почту, я с удовольствием Вам помогу.</p>\n<h2 id=\"baza-dannyh-i-modeli\"><a name=\"baza-dannyh-i-modeli\" class=\"h-link\" href=\"#\"></a>База данных и модели</h2>\n<p>Изменим структуру директорий следующим образом</p>\n<pre><code class=\"hljs language-bash\">|-app\n|---code\n|-----<span class=\"hljs-built_in\">local</span>\n|-------Freaks\n|---------Quotes\n|-----------Block\n|-----------controllers\n|-----------etc\n|-----------Helper\n|-------------Data.php\n|-----------Model\n|-------------Resource\n|---------------Quote\n|-----------------Collection.php\n|---------------Quote.php\n|-------------Quote.php\n|-----------sql\n|-------------freaks_quotes_setup\n|---------------mysql4-install-0.2.0.php\n</code></pre>\n<p>Для управлением данными в Magento используются модели. Для одной таблицы нужно создать 3 модели, одна для управления бизнес логикой, вторая - называется <em>resource</em> модель, используется для непосредственной работы с базой данных и третья - для управления обновлениями. Вся информация о связях моделей находится в <strong>config.xml</strong>. Изменим его с учетом этого</p>\n<pre><code class=\"hljs language-xml\"><span class=\"hljs-meta\">&lt;?xml version=\"1.0\"?&gt;</span>\n<span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">config</span>&gt;</span>\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">modules</span>&gt;</span>\n        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">Freaks_Quotes</span>&gt;</span>\n            <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">version</span>&gt;</span>0.2.0<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">version</span>&gt;</span>\n        <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">Freaks_Quotes</span>&gt;</span>\n    <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">modules</span>&gt;</span>\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">global</span>&gt;</span>\n        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">blocks</span>&gt;</span>\n            <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">freaks_quotes</span>&gt;</span>\n                <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">class</span>&gt;</span>Freaks_Quotes_Block<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">class</span>&gt;</span>\n            <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">freaks_quotes</span>&gt;</span>\n        <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">blocks</span>&gt;</span>\n        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">helpers</span>&gt;</span>\n            <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">freaks_quotes</span>&gt;</span><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">class</span>&gt;</span>Freaks_Quotes_Helper<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">class</span>&gt;</span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">freaks_quotes</span>&gt;</span>\n        <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">helpers</span>&gt;</span>\n        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">models</span>&gt;</span>\n            <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">freaks_quotes</span>&gt;</span>\n                <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">class</span>&gt;</span>Freaks_Quotes_Model<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">class</span>&gt;</span>\n                <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">resourceModel</span>&gt;</span>quotes_resource<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">resourceModel</span>&gt;</span>\n            <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">freaks_quotes</span>&gt;</span>\n            <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">quotes_resource</span>&gt;</span>\n                <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">class</span>&gt;</span>Freaks_Quotes_Model_Resource<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">class</span>&gt;</span>\n                <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">entities</span>&gt;</span>\n                    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">quote</span>&gt;</span>\n                        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">table</span>&gt;</span>freaks_quotes<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">table</span>&gt;</span>\n                    <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">quote</span>&gt;</span>\n                <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">entities</span>&gt;</span>\n            <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">quotes_resource</span>&gt;</span>\n        <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">models</span>&gt;</span>\n        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">resources</span>&gt;</span>\n            <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">freaks_quotes_setup</span>&gt;</span>\n                <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">setup</span>&gt;</span>\n                    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">module</span>&gt;</span>Freaks_Quotes<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">module</span>&gt;</span>\n                <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">setup</span>&gt;</span>\n                <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">connection</span>&gt;</span>\n                    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">use</span>&gt;</span>core_setup<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">use</span>&gt;</span>\n                <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">connection</span>&gt;</span>\n            <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">freaks_quotes_setup</span>&gt;</span>\n            <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">freaks_quotes_write</span>&gt;</span>\n                <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">connection</span>&gt;</span>\n                    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">use</span>&gt;</span>core_write<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">use</span>&gt;</span>\n                <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">connection</span>&gt;</span>\n            <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">freaks_quotes_write</span>&gt;</span>\n            <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">freaks_quotes_read</span>&gt;</span>\n                <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">connection</span>&gt;</span>\n                    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">use</span>&gt;</span>core_read<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">use</span>&gt;</span>\n                <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">connection</span>&gt;</span>\n            <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">freaks_quotes_read</span>&gt;</span>\n        <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">resources</span>&gt;</span>\n    <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">global</span>&gt;</span>\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">frontend</span>&gt;</span>\n        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">routers</span>&gt;</span>\n            <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">freaks_quotes</span>&gt;</span>\n                <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">use</span>&gt;</span>standard<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">use</span>&gt;</span>\n                <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">args</span>&gt;</span>\n                    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">module</span>&gt;</span>Freaks_Quotes<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">module</span>&gt;</span>\n                    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">frontName</span>&gt;</span>quotes<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">frontName</span>&gt;</span>\n                <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">args</span>&gt;</span>\n            <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">freaks_quotes</span>&gt;</span>\n        <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">routers</span>&gt;</span>\n        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">layout</span>&gt;</span>\n            <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">updates</span>&gt;</span>\n                <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">freaks_quotes</span>&gt;</span>\n                    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">file</span>&gt;</span>freaks/quotes.xml<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">file</span>&gt;</span>\n                <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">freaks_quotes</span>&gt;</span>\n            <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">updates</span>&gt;</span>\n        <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">layout</span>&gt;</span>\n    <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">frontend</span>&gt;</span>\n<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">config</span>&gt;</span>\n</code></pre>\n<p>Теперь посмотрим, что и зачем было добавлено в конфигурацию</p>\n<ul>\n<li><em>helpers</em> - указывает суфикс класса-помощника, который понадобится в дальнейшем в шаблонах і блоках</li>\n<li><em>models</em> - модели для работы с базой данных и связь ресурс-модели и бизнес модели. <em>resourceModel</em> - это имя элемента xml-конфигурации, в котором описывается ресурс-модель</li>\n<li><em>resources</em> - указывает, модели для работы с данными для записи, чтения и обновления (или установки модуля)</li>\n</ul>\n<p>Будьте внимательны и не забудьте поменять версию модуля в настройках, иначе файли установки модуля не будут выполнены!</p>\n<p>Создадим модели. Открываем <strong>app/code/local/Freaks/Quotes/Model/Quote.php</strong></p>\n<pre><code class=\"hljs language-php\"><span class=\"hljs-meta\">&lt;?php</span>\n<span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">Freaks_Quotes_Model_Quote</span> <span class=\"hljs-keyword\">extends</span> <span class=\"hljs-title\">Mage_Core_Model_Abstract</span>\n</span>{\n    <span class=\"hljs-keyword\">protected</span> <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">_construct</span><span class=\"hljs-params\">()</span>\n    </span>{\n        <span class=\"hljs-keyword\">$this</span>-&gt;_init(<span class=\"hljs-string\">'freaks_quotes/quote'</span>);\n    }\n}\n</code></pre>\n<p>этот код на самом деле почти ничего не делает :). Он всего лишь привязывает ресурс-модель к бизнес-модели. Создадим же теперь ресурс-модель в <strong>app/code/local/Freaks/Quotes/Model/Resource/Quote.php</strong></p>\n<pre><code class=\"hljs language-php\"><span class=\"hljs-meta\">&lt;?php</span>\n<span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">Freaks_Quotes_Model_Resource_Quote</span> <span class=\"hljs-keyword\">extends</span> <span class=\"hljs-title\">Mage_Core_Model_Mysql4_Abstract</span>\n</span>{\n    <span class=\"hljs-keyword\">protected</span> <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">_construct</span><span class=\"hljs-params\">()</span>\n    </span>{\n        <span class=\"hljs-keyword\">$this</span>-&gt;_init(<span class=\"hljs-string\">'freaks_quotes/quote'</span>, <span class=\"hljs-string\">'id'</span>);\n    }\n}\n</code></pre>\n<p>На удивление код почти идентичен :), но делает он совсем другое... Эти строки значат, что нужно обратится в xml-конфигурацию по пути <code>**config** &gt; **global** &gt; **models** &gt; **quotes_resource** &gt; **entities** &gt; **quote**</code>, чтобы узнать имя таблицы.</p>\n<p>Теперь создадим модель-коллекции ресурс-модели. На самом деле, это обычный класс, который отвечает за работу с набором моделей, поэтому я не упоминал об этом классе, как об отдельной модели. Редактируем <strong>app/code/local/Freaks/Quotes/Model/Resource/Quote/Collection.php</strong></p>\n<pre><code class=\"hljs language-php\"><span class=\"hljs-meta\">&lt;?php</span>\n<span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">Freaks_Quotes_Model_Resource_Quote_Collection</span> <span class=\"hljs-keyword\">extends</span> <span class=\"hljs-title\">Mage_Core_Model_Mysql4_Collection_Abstract</span>\n</span>{\n    <span class=\"hljs-keyword\">protected</span> <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">_construct</span><span class=\"hljs-params\">()</span>\n    </span>{\n        <span class=\"hljs-keyword\">$this</span>-&gt;_init(<span class=\"hljs-string\">'freaks_quotes/quote'</span>);\n    }\n}\n</code></pre>\n<p>В конструкторе задаем набор каких моделей будет содержать наша коллекция.</p>\n<p>На конец осталось создать только файли установки модуля. Открываем <strong>app/code/local/Freaks/Quotes/sql/quotes_setup</strong>**/mysql4-install-0.2.0.php**</p>\n<pre><code class=\"hljs language-php\"><span class=\"hljs-meta\">&lt;?php</span>\n$installer = <span class=\"hljs-keyword\">$this</span>;\n$installer-&gt;startSetup();\n\n$installer-&gt;run(<span class=\"hljs-string\">\"\nCREATE TABLE `{$this-&gt;getTable('freaks_quotes/quote')}` (\n `id` int(10) unsigned NOT NULL AUTO_INCREMENT,\n `name` varchar(255) NOT NULL,\n `dscr` mediumtext NOT NULL,\n PRIMARY KEY (`id`)\n) ENGINE=InnoDB DEFAULT CHARSET=utf8\n\"</span>);\n\n$installer-&gt;endSetup();\n</code></pre>\n<p>После первого запроса на сайт, этот файл будет выполнен. Пробуем и смотрим, что же получилось. Добавим несколько строк тестовых данных в базу через любой удобный для вас UI (я, например, использую <a href=\"http://www.phpmyadmin.net/home_page/downloads.php\" target=\"_blank\" rel=\"noopener nofollow\">phpMyAdmin</a>).</p>\n<h2 id=\"bloki-i-shablony\"><a name=\"bloki-i-shablony\" class=\"h-link\" href=\"#\"></a>Блоки и шаблоны</h2>\n<p>По сколько модели созданы теперь можно работать с данными через очень простой интерфейс. Отредактируем наш блок (<strong>app/code/local/Freaks/Quotes/Block/Content.php</strong>)</p>\n<pre><code class=\"hljs language-php\"><span class=\"hljs-meta\">&lt;?php</span>\n<span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">Freaks_Quotes_Block_Content</span> <span class=\"hljs-keyword\">extends</span> <span class=\"hljs-title\">Mage_Core_Block_Template</span>\n</span>{\n    <span class=\"hljs-keyword\">protected</span> <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">_construct</span><span class=\"hljs-params\">()</span>\n    </span>{\n        <span class=\"hljs-keyword\">$this</span>-&gt;setTemplate(<span class=\"hljs-string\">'freaks/quotes/view.phtml'</span>);\n    }\n\n    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">getRowUrl</span><span class=\"hljs-params\">(Freaks_Quotes_Model_Quote $quote)</span>\n    </span>{\n        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">$this</span>-&gt;getUrl(<span class=\"hljs-string\">'*/*/view'</span>, <span class=\"hljs-keyword\">array</span>(\n            <span class=\"hljs-string\">'id'</span> =&gt; $quote-&gt;getId()\n        ));\n    }\n\n    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">getCollection</span><span class=\"hljs-params\">()</span>\n    </span>{\n        <span class=\"hljs-keyword\">return</span> Mage::getModel(<span class=\"hljs-string\">'freaks_quotes/quote'</span>)-&gt;getCollection();\n    }\n}\n</code></pre>\n<p>В конструкторе блока устанавливаем ему шаблон, который будет отображать список цитат. Давайте создадим же этот файл (<strong>app/design/frontend/base/default/template/freaks/quotes/view.phtml</strong>)</p>\n<pre><code class=\"hljs language-php\"><span class=\"hljs-meta\">&lt;?php</span> <span class=\"hljs-keyword\">foreach</span> (<span class=\"hljs-keyword\">$this</span>-&gt;getCollection() <span class=\"hljs-keyword\">as</span> $quote): <span class=\"hljs-meta\">?&gt;</span>\n&lt;div <span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span>=\"<span class=\"hljs-title\">quote</span>-<span class=\"hljs-title\">item</span>\"&gt;\n    &lt;<span class=\"hljs-title\">h4</span>&gt;&lt;<span class=\"hljs-title\">a</span> <span class=\"hljs-title\">href</span>=\"&lt;?<span class=\"hljs-title\">php</span> <span class=\"hljs-title\">echo</span> $<span class=\"hljs-title\">this</span>-&gt;<span class=\"hljs-title\">getRowUrl</span>($<span class=\"hljs-title\">quote</span>) ?&gt;\"&gt;&lt;?<span class=\"hljs-title\">php</span> <span class=\"hljs-title\">echo</span> $<span class=\"hljs-title\">quote</span>-&gt;<span class=\"hljs-title\">getName</span>() ?&gt;&lt;/<span class=\"hljs-title\">a</span>&gt;&lt;/<span class=\"hljs-title\">h4</span>&gt;\n    &lt;<span class=\"hljs-title\">p</span>&gt;&lt;?<span class=\"hljs-title\">php</span> <span class=\"hljs-title\">echo</span> $<span class=\"hljs-title\">quote</span>-&gt;<span class=\"hljs-title\">getDscr</span>() ?&gt;&lt;/<span class=\"hljs-title\">p</span>&gt;\n&lt;/<span class=\"hljs-title\">div</span>&gt;\n&lt;?<span class=\"hljs-title\">php</span> <span class=\"hljs-title\">endforeach</span> ?&gt;\n</span></code></pre>\n<p>У меня он очень простой, вы же можете пофантазировать и поработать творчески ;) Обновим нашу страничку и смотрим результат</p>\n<p><img src=\"/media/assets/magento-custom-module.png\" alt=\"Свой модуль на Magento - результат\" title=\"Свой модуль на Magento - результат\" width=\"600\" height=\"332\">Чтобы просматривать цытаты нужно создать <em>viewAction</em> в контроллере, блок и еще один шаблон. Приступим, редактируем <strong>app/code/local/Freaks/Quotes/controllers/indexController.php</strong></p>\n<pre><code class=\"hljs language-php\"><span class=\"hljs-meta\">&lt;?php</span>\n<span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">Freaks_Quotes_IndexController</span> <span class=\"hljs-keyword\">extends</span> <span class=\"hljs-title\">Mage_Core_Controller_Front_Action</span>\n</span>{\n     <span class=\"hljs-keyword\">public</span> <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">indexAction</span><span class=\"hljs-params\">()</span>\n     </span>{\n        <span class=\"hljs-keyword\">$this</span>-&gt;loadLayout()\n            -&gt;renderLayout();\n     }\n\n     <span class=\"hljs-keyword\">public</span> <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">viewAction</span><span class=\"hljs-params\">()</span>\n     </span>{\n         $quote_id = (int)<span class=\"hljs-keyword\">$this</span>-&gt;getRequest()-&gt;getParam(<span class=\"hljs-string\">'id'</span>);\n         <span class=\"hljs-keyword\">if</span> (!$quote_id) {\n             <span class=\"hljs-keyword\">$this</span>-&gt;_forward(<span class=\"hljs-string\">'noRoute'</span>);\n         }\n         <span class=\"hljs-keyword\">$this</span>-&gt;loadLayout();\n         <span class=\"hljs-keyword\">$this</span>-&gt;getLayout()\n            -&gt;getBlock(<span class=\"hljs-string\">'quote.item'</span>)\n            -&gt;setQuoteId($quote_id);\n         <span class=\"hljs-keyword\">$this</span>-&gt;renderLayout();\n     }\n}\n</code></pre>\n<p>Поскольку блоки наследуются от <em>Varien_Object</em> класса, то в него можно передать любое значение посредством сеттеров и геттеров. Именно таким образом передаем идентификатор цитаты в блок.</p>\n<p>Создадим <em>helper</em> для модуля, так как в шаблонах нам нужно будет переводить строки. Открываем <strong>app/code/local/Freaks/Quotes/Helper/Data.php</strong></p>\n<pre><code class=\"hljs language-php\"><span class=\"hljs-meta\">&lt;?php</span>\n<span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">Freaks_Quotes_Helper_Data</span> <span class=\"hljs-keyword\">extends</span> <span class=\"hljs-title\">Mage_Core_Helper_Abstract</span>\n</span>{\n}\n</code></pre>\n<p>Да вот такой у нас &quot;сложный&quot; <em>helper</em> :)</p>\n<p>В <em>layout</em>-конфигурации создадим <em>handle</em> для <em>viewAction</em>-а, в котором в контент подключим блок для отображения одной цитаты (<strong>app/design/frontend/base/default/layout/freaks/quotes.xml</strong>)</p>\n<pre><code class=\"hljs language-xml\"><span class=\"hljs-meta\">&lt;?xml version=\"1.0\"?&gt;</span>\n<span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">layout</span> <span class=\"hljs-attr\">version</span>=<span class=\"hljs-string\">\"0.1.0\"</span>&gt;</span>\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">freaks_quotes_index_index</span>&gt;</span>\n        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">reference</span> <span class=\"hljs-attr\">name</span>=<span class=\"hljs-string\">\"content\"</span>&gt;</span>\n            <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">block</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"freaks_quotes/content\"</span> <span class=\"hljs-attr\">name</span>=<span class=\"hljs-string\">\"quotes.all\"</span> /&gt;</span>\n        <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">reference</span>&gt;</span>\n    <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">freaks_quotes_index_index</span>&gt;</span>\n\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">freaks_quotes_index_view</span>&gt;</span>\n        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">reference</span> <span class=\"hljs-attr\">name</span>=<span class=\"hljs-string\">\"content\"</span>&gt;</span>\n            <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">block</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"freaks_quotes/quote_content\"</span> <span class=\"hljs-attr\">name</span>=<span class=\"hljs-string\">\"quote.item\"</span> /&gt;</span>\n        <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">reference</span>&gt;</span>\n    <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">freaks_quotes_index_view</span>&gt;</span>\n<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">layout</span>&gt;</span>\n</code></pre>\n<p>Создаем блок <strong>app/code/local/Freaks/Quotes/Block/Quote/Content.php</strong></p>\n<pre><code class=\"hljs language-php\"><span class=\"hljs-meta\">&lt;?php</span>\n<span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">Freaks_Quotes_Block_Quote_Content</span> <span class=\"hljs-keyword\">extends</span> <span class=\"hljs-title\">Mage_Core_Block_Template</span>\n</span>{\n    <span class=\"hljs-keyword\">protected</span> <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">_construct</span><span class=\"hljs-params\">()</span>\n    </span>{\n        <span class=\"hljs-keyword\">$this</span>-&gt;setTemplate(<span class=\"hljs-string\">'freaks/quotes/quote/view.phtml'</span>);\n    }\n\n    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">getQuote</span><span class=\"hljs-params\">()</span>\n    </span>{\n        <span class=\"hljs-keyword\">return</span> Mage::getModel(<span class=\"hljs-string\">'freaks_quotes/quote'</span>)-&gt;load(<span class=\"hljs-keyword\">$this</span>-&gt;getQuoteId());\n    }\n}\n</code></pre>\n<p>Ну и последнее - шаблон <strong>app/design/frontend/base/default/template/freaks/quotes/quote/view.phtml</strong></p>\n<pre><code class=\"hljs language-php\"><span class=\"hljs-meta\">&lt;?php</span> $quote = <span class=\"hljs-keyword\">$this</span>-&gt;getQuote() <span class=\"hljs-meta\">?&gt;</span>\n&lt;h1&gt;<span class=\"hljs-meta\">&lt;?php</span> <span class=\"hljs-keyword\">echo</span> Mage::helper(<span class=\"hljs-string\">'freaks_quotes'</span>)-&gt;__(<span class=\"hljs-string\">'View quote \"%s\"'</span>, $quote-&gt;getName()) <span class=\"hljs-meta\">?&gt;</span>&lt;/h1&gt;\n&lt;p&gt;<span class=\"hljs-meta\">&lt;?php</span> <span class=\"hljs-keyword\">echo</span> $quote-&gt;getDscr() <span class=\"hljs-meta\">?&gt;</span>&lt;/p&gt;\n</code></pre>\n<p>Проверяем результат :)</p>\n<p><img src=\"/media/assets/magento-view-quote.png\" alt=\"Свой модуль на Magento - просмотр цытата\" title=\"Свой модуль на Magento - просмотр цытата\" width=\"600\" height=\"327\"></p>\n<p>Вот и все. В следующей статье создадим модуль для редактирования цитат в административной панели.</p>\n<p>Этот модуль можно скачать <app-link to=\"page\" params=\"{&quot;id&quot;:&quot;backend/2011-01/magento-sozdanie-crud-modulya/FreaksQuotes.tar.bz2&quot;}\">ЗДЕСЬ</app-link>.</p>","headings":[["nachalo","Начало"],["baza-dannyh-i-modeli","База данных и модели"],["bloki-i-shablony","Блоки и шаблоны"]]}