{"title":"sjFilemanager - Эволюция. PHP + AJAX файловый менеджер","summary":"Пришло время сдержать свое обещание и реализовать задуманные фичи в своем\nфайловом менеджере, который достаточно сильно упрощает работу с файлами мне на\nэтом блоге. Итак давайте разбираться\n","author":"sstotskyi","categories":["frontend","important"],"createdAt":"2011-10-29T20:20:00.000Z","meta":{"keywords":["файловый менеджер","ajax","sjFilemanager"]},"alias":"sjfilemanager---evolyutsiya-php--ajax-fajlovyj-menedzher","content":"<p>Когда-то, давным давно все началось с <app-link to=\"frontend\" params=\"{&quot;id&quot;:&quot;sjfilemanager-besplatnyi-ajax-fail-menedzher&quot;}\">этого</app-link> и <a href=\"http://habrahabr.ru/blogs/javascript/113257/\" target=\"_blank\" rel=\"noopener nofollow\">этого</a>. Вообще-то благодаря тому, что я написал файловый менеджер я завел блог и получил аккаунт на <a href=\"http://habrahabr.ru/\" target=\"_blank\" rel=\"noopener nofollow\">Хабре</a>. С тех пор много чего изменилось и произошло.</p>\n<p><img src=\"/media/assets/sjFilemanager.png\" alt=\"sjFilemanager v1.0b\" title=\"sjFilemanager v1.0b\" width=\"707\" height=\"431\"></p>\n<h2 id=\"nachnem-s-primera\"><a name=\"nachnem-s-primera\" class=\"h-link\" href=\"#\"></a>Начнем с примера</h2>\n<p><strong>Update</strong>: все примеры удалены в связи с переездом на статический движок. Переносить на какой-то codesandbox нет желаний :)</p>\n<p>Думаю для начала все хотят попробовать, что-там интересного</p>\n<ul>\n<li><s>здесь</s>, только файловый менеджер на странице</li>\n<li><s>здесь</s>, только редактор изображений на странице</li>\n<li><s>здесь</s>, только файловый менеджер в попапе</li>\n<li><s>здесь</s>, файловый менеджер и редактор изображений в попапе</li>\n</ul>\n<p>Об основных изменениях можно почитать на <a href=\"http://habrahabr.ru/blogs/javascript/131489/\" target=\"_blank\" rel=\"noopener nofollow\">Хабре</a>, а здесь поговорим о настройках</p>\n<h2 id=\"ustanovka\"><a name=\"ustanovka\" class=\"h-link\" href=\"#\"></a>Установка</h2>\n<p>Установить можно скачав с <a href=\"http://ru.wikipedia.org/wiki/Git\" target=\"_blank\" rel=\"noopener nofollow\">GIT</a> репозитория git://github.com/stalniy/sjFilemanager.git</p>\n<h2 id=\"obratnaya-svyaz\"><a name=\"obratnaya-svyaz\" class=\"h-link\" href=\"#\"></a>Обратная связь</h2>\n<p>Просьба все найденные баги и предложения писать <a href=\"https://github.com/stalniy/sjFilemanager/issues\" title=\"sjFilemanager bug tracker\" target=\"_blank\" rel=\"noopener nofollow\">здесь</a> или в комментариях</p>\n<h2 id=\"konfiguracziya\"><a name=\"konfiguracziya\" class=\"h-link\" href=\"#\"></a>Конфигурация</h2>\n<p>Теперь, чтобы инициализировать файловый менеджер нужно намного меньше строчек кода. Все лишнее удалено или перенесено в настройки по умолчанию. Будем рассматривать пример с полным функционалом, где файловый менеджер работает вместе с редактором рисунков. Как всегда нужно что-то подключить, а именно ряд файлов. Так как нам нужно для продакшена, то будем подключать уменьшенный вариант <em>css</em> и <em>javascript</em>. Если нужна локализация на другой язык, то подключаем также файл переводов.</p>\n<pre><code class=\"hljs language-html\"><span class=\"hljs-meta\">&lt;!DOCTYPE <span class=\"hljs-meta-keyword\">html</span> <span class=\"hljs-meta-keyword\">PUBLIC</span> <span class=\"hljs-meta-string\">\"-//W3C//DTD XHTML 1.0 Transitional//EN\"</span> <span class=\"hljs-meta-string\">\"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd\"</span>&gt;</span>\n<span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">html</span> <span class=\"hljs-attr\">xmlns</span>=<span class=\"hljs-string\">\"http://www.w3.org/1999/xhtml\"</span>&gt;</span>\n<span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">head</span>&gt;</span>\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">meta</span> <span class=\"hljs-attr\">http-equiv</span>=<span class=\"hljs-string\">\"Content-Type\"</span> <span class=\"hljs-attr\">content</span>=<span class=\"hljs-string\">\"text/html; charset=utf-8\"</span> /&gt;</span>\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">title</span>&gt;</span>Файловый и медиа менеджеры в окне<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">title</span>&gt;</span>\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">meta</span> <span class=\"hljs-attr\">http-equiv</span>=<span class=\"hljs-string\">\"imagetoolbar\"</span> <span class=\"hljs-attr\">content</span>=<span class=\"hljs-string\">\"no\"</span> /&gt;</span>\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span> <span class=\"hljs-attr\">src</span>=<span class=\"hljs-string\">\"/demos/sj_filemanager/js/lang/lang_ru.js\"</span>&gt;</span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span>\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span> <span class=\"hljs-attr\">src</span>=<span class=\"hljs-string\">\"/demos/sj_filemanager/js/sjFilemanager.full.js\"</span>&gt;</span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span>\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">link</span> <span class=\"hljs-attr\">href</span>=<span class=\"hljs-string\">\"/demos/sj_filemanager/css/sjFilemanager.full.css\"</span> <span class=\"hljs-attr\">rel</span>=<span class=\"hljs-string\">\"stylesheet\"</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/css\"</span> /&gt;</span>\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span> <span class=\"hljs-attr\">src</span>=<span class=\"hljs-string\">\"/weCmsPlugin/js/tiny_mce/tiny_mce.js\"</span>&gt;</span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span>\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;</span><span class=\"javascript\">\n        sjs.ready(<span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span>(<span class=\"hljs-params\"></span>)</span>{\n            sjWindow.renderView();\n            MediaManager.renderView($_LANG);\n\n            <span class=\"hljs-keyword\">var</span> baseUrl = <span class=\"hljs-string\">'/demos/sj_filemanager/'</span>;\n\n            <span class=\"hljs-keyword\">var</span> w = FileManage.getInstance(<span class=\"hljs-literal\">null</span>, baseUrl + <span class=\"hljs-string\">\"?tmpl=window&amp;show_actions=1\"</span>, {\n                <span class=\"hljs-attr\">actionUrl</span>: baseUrl,\n                <span class=\"hljs-attr\">rootUrl</span>: <span class=\"hljs-string\">'/uploads/sjFilemanager'</span>\n            },{\n                <span class=\"hljs-attr\">move</span>: <span class=\"hljs-literal\">true</span>,\n                <span class=\"hljs-attr\">resizable</span>: <span class=\"hljs-literal\">true</span>\n            }).attachListeners({\n                <span class=\"hljs-attr\">ready</span>: <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span>(<span class=\"hljs-params\"></span>) </span>{\n                    <span class=\"hljs-keyword\">this</span>.setUploader(FileManage.getUploader(baseUrl));\n                    MediaManager.getInstance(sjs(<span class=\"hljs-string\">'#sjMediamanager'</span>).insertBefore(<span class=\"hljs-string\">'#sjWrapper'</span>).find(<span class=\"hljs-string\">'.sjMediaWrapper'</span>), {\n                         <span class=\"hljs-attr\">lazy</span>: <span class=\"hljs-literal\">true</span>,\n                        <span class=\"hljs-attr\">saveUrl</span>: baseUrl\n                    }).syncWithFileManager(<span class=\"hljs-keyword\">this</span>, <span class=\"hljs-string\">'refresh'</span>);\n                },\n                <span class=\"hljs-attr\">click</span>: <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span>(<span class=\"hljs-params\"></span>) </span>{\n                    <span class=\"hljs-keyword\">var</span> mm = MediaManager.getInstance(), files;\n                    <span class=\"hljs-keyword\">this</span>.makeStek();\n                    <span class=\"hljs-keyword\">if</span> (!mm.isSleepy &amp;&amp; (files = <span class=\"hljs-keyword\">this</span>.getFiles())) {\n                        mm.setFiles(files).showFile();\n                    }\n                }\n            });\n        });\n\n        tinyMCE.init({\n            <span class=\"hljs-comment\">// General options</span>\n            <span class=\"hljs-attr\">mode</span> : <span class=\"hljs-string\">\"textareas\"</span>,\n            <span class=\"hljs-attr\">theme</span> : <span class=\"hljs-string\">\"advanced\"</span>,\n            <span class=\"hljs-attr\">plugins</span> : <span class=\"hljs-string\">\"media,pagebreak,style,layer,table,save,advhr,advimage,advlink,emotions,iespell,inlinepopups,insertdatetime,preview,media,searchreplace,print,contextmenu,paste,directionality,fullscreen,noneditable,visualchars,nonbreaking,xhtmlxtras\"</span>,\n            <span class=\"hljs-attr\">editor_selector</span> : <span class=\"hljs-string\">\"mceEditor\"</span>,\n            <span class=\"hljs-attr\">language</span> : <span class=\"hljs-string\">\"en\"</span>,\n            <span class=\"hljs-attr\">convert_urls</span>: <span class=\"hljs-literal\">false</span>,\n            <span class=\"hljs-attr\">theme</span> : <span class=\"hljs-string\">\"advanced\"</span>,\n            <span class=\"hljs-attr\">debug</span> : <span class=\"hljs-literal\">false</span>,\n            <span class=\"hljs-attr\">paste_auto_cleanup_on_paste</span> : <span class=\"hljs-literal\">true</span>,\n            <span class=\"hljs-attr\">paste_convert_headers_to_strong</span> : <span class=\"hljs-literal\">true</span>,\n            <span class=\"hljs-comment\">// Theme options</span>\n            <span class=\"hljs-attr\">theme_advanced_buttons1</span> :<span class=\"hljs-string\">\"undo,redo,|,bold,italic,underline,strikethrough,forecolor,backcolor,|,sub,sup,charmap,|,hr,removeformat\"</span>,\n            <span class=\"hljs-attr\">theme_advanced_buttons2</span> : <span class=\"hljs-string\">\"pastetext,pasteword,|,search,|,bullist,numlist,|,outdent,indent,|,link,unlink,image,media,cleanup,code,fullscreen\"</span>,\n            <span class=\"hljs-attr\">theme_advanced_buttons3</span> : <span class=\"hljs-string\">\"tablecontrols\"</span>,\n            <span class=\"hljs-comment\">//theme_advanced_buttons4 : \"styleselect,formatselect,fontselect,fontsizeselect\",</span>\n            <span class=\"hljs-attr\">theme_advanced_toolbar_location</span> : <span class=\"hljs-string\">\"top\"</span>,\n            <span class=\"hljs-attr\">theme_advanced_toolbar_align</span> : <span class=\"hljs-string\">\"left\"</span>,\n            <span class=\"hljs-attr\">theme_advanced_statusbar_location</span> : <span class=\"hljs-literal\">false</span>,\n            <span class=\"hljs-attr\">file_browser_callback</span>: <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span>(<span class=\"hljs-params\">field, url, type, win</span>)</span>{\n                <span class=\"hljs-keyword\">if</span> (<span class=\"hljs-built_in\">window</span>.FileManage) {\n                    sjWindow.max_zIndex=<span class=\"hljs-number\">301000</span>;\n                    FileManage.choiseCallback(field, <span class=\"hljs-string\">''</span>, type, win);\n                }\n            }\n        });\n    </span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span>\n<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">head</span>&gt;</span>\n<span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">body</span>&gt;</span>\n        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">h2</span>&gt;</span>sjFilemanager + sjMediamanager + tinyMCE<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">h2</span>&gt;</span>\n        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">textarea</span> <span class=\"hljs-attr\">cols</span>=<span class=\"hljs-string\">\"60\"</span> <span class=\"hljs-attr\">rows</span>=<span class=\"hljs-string\">\"20\"</span> <span class=\"hljs-attr\">class</span>=<span class=\"hljs-string\">\"mceEditor\"</span>&gt;</span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">textarea</span>&gt;</span>\n<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">body</span>&gt;</span>\n</code></pre>\n<p>Когда все <em>DOM</em> объекты загрузятся на странице, начинаем инициализацию менеджера. Но сначала рисуем шаблоны для попапа и редактора рисунков</p>\n<pre><code class=\"hljs language-javascript\">sjWindow.renderView();\nMediaManager.renderView($_LANG);\n</code></pre>\n<p>Потом устанавливаем базовый <strong>URL</strong> - это путь к директории <strong>web</strong> файлового менеджера. У меня на сайте, сам код библиотеки не доступен через <em>http</em>, а директория <em>demos/sj_filemanager</em> является символьной ссылкой на каталог <em>web</em>.</p>\n<p>Если на странице нужен только один файловый менеджер (так бывает в большинстве случаев), то для этого реализован интерфейс <a href=\"http://ru.wikipedia.org/wiki/%D0%9E%D0%B4%D0%B8%D0%BD%D0%BE%D1%87%D0%BA%D0%B0_%28%D1%88%D0%B0%D0%B1%D0%BB%D0%BE%D0%BD_%D0%BF%D1%80%D0%BE%D0%B5%D0%BA%D1%82%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F%29\" target=\"_blank\" rel=\"noopener nofollow\">Singleton</a> в методе <strong>getInstance</strong>. При первом вызове метода, нужно передать конфигурационные параметры. Рассмотрим их</p>\n<ul>\n<li>первый параметр - это <em>callback</em> функция для <em>insert</em> экшена. Необходимо в тех случаях, когда нужно передать информацию о файлах куда-то, например, в <a href=\"http://www.tinymce.com/\" target=\"_blank\" rel=\"noopener nofollow\">tinyMCE</a> или на страницу</li>\n<li>второй параметр - это <em>url</em> по-которому получаем список файлов, в основном он всегда остается одним и тем же</li>\n<li>третий параметр - это хэш конфигурации для файлового менеджера. Допустимые опции:\n<ul>\n<li><em>actionUrl</em> - обязательный, <em>url</em> к файлу, который обрабатывает все действия</li>\n<li><em>dirUrl</em> - необязательный, <em>url</em> к файлу, который отвечает за чтение директорий, по умолчанию равно <strong>actionUrl</strong></li>\n<li><em>rootUrl</em> - необязательный, <em>url</em> к директории, где лежат файлы. В основном необходим для связки с редактором рисунков и <em>tinyMCE</em></li>\n<li><em>actionSel</em> - необязательный, селектор, по которому можно найти блок, в котором находятся все экшены, по умолчанию равно <strong>#sjFmActions</strong></li>\n<li><em>uploader</em> - необязательный, объект отвечающий за загрузку файлов</li>\n<li><em>rowTemplate</em> - необязательный, шаблон строки файла, по умолчанию <strong><tr>....</tr></strong></li>\n</ul>\n</li>\n<li>четвертый параметр - необязательный, конфигурация <em>window</em> менеджера. Настроек здесь очень много, думаю в большинстве случаев подойдут дефолтные</li>\n</ul>\n<p>Потом привязываем <em>listener-и</em> на события, на самом деле это просто <em>callback</em> функции, т.е. на одно событие можно повесить только одну функцию, думаю большего пока не нужно. Но благодаря абстракции в будущем это можно просто изменить.</p>\n<p>Так как мы хотим объединить работу файлового менеджера и редактора рисунков, то в момент когда инициализируется первый, нужно создать второй и познакомить их. Что мы и делаем при помощи события <strong>ready</strong>. Также в этом <em>listener</em>-е на это событие, создаем объект <em>uploader-а</em>, в данном случае - это <a href=\"http://swfupload.org/\" target=\"_blank\" rel=\"noopener nofollow\">SWFUpload</a>. Если нужно переопределить какие-то стандартные настройки <em>uploader-а</em>, то в метод <em>FileManage.getUploader</em> втором параметром можно передать <em>hash</em>.</p>\n<p>Редактор рисунков, я его назвал медиа менеджер, инициализируется по аналогии к файловому менеджеру. Но прежде, создаем для него (медиа менеджера) шаблон и переносим в попап окно к файловому менеджеру. Рассмотрим параметры конфигурации медиа менеджера</p>\n<ul>\n<li>\n<p>первый параметр - обязательный, <strong>DOM</strong> объект, в котором будет содержатся контент редактора</p>\n</li>\n<li>\n<p>второй параметр - необязательный, конфигурация</p>\n<ul>\n<li>\n<p><em>panel</em> - необязательный, селектор, по-которому можно найти панель экшенов для редактора. По умолчанию <strong>.sjMediaPanel</strong></p>\n</li>\n<li>\n<p><em>lazy</em> - необязательный, указывает, что нужно инициализировать редактор частично. По умолчанию <strong>false</strong></p>\n</li>\n<li>\n<p><em>mode</em> - необязательный, указывает поведение редактора. Возможны 2 варианта: <strong>preview</strong>, <strong>full</strong>. По умолчанию <strong>preview</strong></p>\n</li>\n<li>\n<p><em>files</em> - необязательный, список обрабатываемых файлов</p>\n</li>\n</ul>\n</li>\n</ul>\n<p>Потом вызываем метод медиа менеджера <strong>syncWithFileManager</strong>, который позволяет добавить кнопку открытия редактора в панель файлового менеджера. На событие <strong>click</strong> по файлу или папке, проверяем включен ли медиа менеджер, если включен, то передаем ему выбранные файлы и показываем первый из них.</p>\n<p>Для работы с <em>tinyMCE</em> используется все тот же метод <em>FileManage.choiseCallback</em>, в который передается <em>DOM</em> объект <strong>input</strong> поля и <em>url</em>, по-которому можно получить доступ к файлам (по умолчанию берется <em>rootUrl</em> из файлового менеджера). Для <em>window</em> менеджера устанавливается большой <strong>zIndex</strong>, для того чтобы перекрить окно <em>tinyMCE</em>, в котором <em>zIndex</em> очень большой.</p>\n<p>Для упрощения совместной инициализации был написан простой метод, т.е. чтобы инициализировать менеджер достаточно передать <em>url</em> к его <em>web</em> директории и <em>url</em> к директории, где находятся файлы, которые находятся под ответственностью менеджера</p>\n<pre><code class=\"hljs language-ts\">FileManage.createAndAttachMedia(baseUrl, rootUrl, translations?);\n</code></pre>\n<p>Конфигурация в серверной части не изменилась, она находится в <em>lib/php/config.php</em>. Более детально о ней можно узнать <app-link to=\"frontend\" params=\"{&quot;id&quot;:&quot;sjfilemanager-konfighuriruem-failovyi-menedzher&quot;}\">здесь</app-link></p>\n<p><strong>UPDATE</strong>:</p>\n<ul>\n<li>\n<p>исправлен баг: отсутствие сообщения при попытке создать каталог не имея на это прав доступа</p>\n</li>\n<li>\n<p>добавлена возможность передавать настройки для загрузчика <em>SWFUpload</em></p>\n<pre><code class=\"hljs language-javascript\">FileManage.createAndAttachMedia(baseUrl, rootUrl[, translations[,uploaderConfig]]);\n</code></pre>\n</li>\n<li>\n<p>конфигурация на <em>backend</em>-е вынесена <em>config.json</em> файл</p>\n</li>\n<li>\n<p><a href=\"/media/assets/sjfm_and_tinymce.tar.gz\" title=\"sjFilemanger + TineMCE\" download=\"sjfm_and_tinymce.tar.gz\">архив</a> с примером интеграции <strong>sjFilemanger</strong> + <strong>TinyMCE</strong> (достаточно розархивировать его в корне виртуального хоста)</p>\n</li>\n</ul>","headings":[["nachnem-s-primera","Начнем с примера"],["ustanovka","Установка"],["obratnaya-svyaz","Обратная связь"],["konfiguracziya","Конфигурация"]],"id":"sjfilemanager-evolyutsiya-php-ajax-fajlovyj-menedzher"}