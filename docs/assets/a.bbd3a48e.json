{"title":"sjFilemanager - конфигурируем файловый менеджер","summary":"В этой статье я расскажу о том как настроить sjFilemanager под свои нужды. И\nсоздам sjFilemanagerPlugin для Symfony 1.4\n","author":"sstotskyi","categories":["backend"],"createdAt":"2011-01-22T13:22:00.000Z","meta":{"keywords":["файловый менеджер","ajax","symfony plugin"]},"alias":"sjfilemanager---konfiguriruem-fajlovyj-menedzher","content":"<p>Итак приступаем к делу! Конфигурация задается в виде ассоциативного массива*.</p>\n<h2 id=\"bazovye-nastrojki\"><a name=\"bazovye-nastrojki\" class=\"h-link\" href=\"#\"></a>Базовые настройки</h2>\n<pre><code class=\"hljs language-php\">$sjConfig = <span class=\"hljs-keyword\">array</span>(\n<span class=\"hljs-comment\">#    'allowed_actions' =&gt; array(),</span>\n    <span class=\"hljs-string\">'charset'</span>  =&gt; <span class=\"hljs-string\">'utf-8'</span>,\n    <span class=\"hljs-string\">'base_dir'</span> =&gt; dirname(dirname(dirname(<span class=\"hljs-keyword\">__FILE__</span>))),\n    <span class=\"hljs-string\">'root'</span> =&gt; $_SERVER[<span class=\"hljs-string\">'DOCUMENT_ROOT'</span>] . <span class=\"hljs-string\">'/media/uploads'</span>,\n    <span class=\"hljs-string\">'uploader'</span>   =&gt; <span class=\"hljs-keyword\">array</span>(\n       <span class=\"hljs-string\">'allowed_types'</span> =&gt; <span class=\"hljs-keyword\">array</span>(<span class=\"hljs-string\">'jpeg'</span>,<span class=\"hljs-string\">'jpg'</span>,<span class=\"hljs-string\">'rar'</span>,<span class=\"hljs-string\">'png'</span>,<span class=\"hljs-string\">'doc'</span>,<span class=\"hljs-string\">'docx'</span>,<span class=\"hljs-string\">'ppt'</span>,<span class=\"hljs-string\">'pptx'</span>,<span class=\"hljs-string\">'xls'</span>,<span class=\"hljs-string\">'xlsx'</span>,<span class=\"hljs-string\">'mdb'</span>,<span class=\"hljs-string\">'accdb'</span>, <span class=\"hljs-string\">'swf'</span>, <span class=\"hljs-string\">'zip'</span>, <span class=\"hljs-string\">'rtf'</span>, <span class=\"hljs-string\">'pdf'</span>, <span class=\"hljs-string\">'psd'</span>, <span class=\"hljs-string\">'mp3'</span>, <span class=\"hljs-string\">'wma'</span>, <span class=\"hljs-string\">'flv'</span>, <span class=\"hljs-string\">'mp4'</span>),\n        <span class=\"hljs-string\">'dynamic_name'</span> =&gt; <span class=\"hljs-keyword\">true</span>,\n        <span class=\"hljs-string\">'override'</span> =&gt; <span class=\"hljs-keyword\">false</span>,\n        <span class=\"hljs-string\">'images'</span>   =&gt; <span class=\"hljs-keyword\">array</span>(\n            <span class=\"hljs-string\">'width'</span> =&gt; <span class=\"hljs-number\">500</span>,\n            <span class=\"hljs-string\">'height'</span>=&gt; <span class=\"hljs-number\">500</span>,\n            <span class=\"hljs-string\">'type'</span>  =&gt; <span class=\"hljs-string\">'width'</span>, <span class=\"hljs-comment\">// width, height, auto, zoom</span>\n            <span class=\"hljs-string\">'crop'</span>  =&gt; <span class=\"hljs-string\">'left-top'</span> <span class=\"hljs-comment\"># left-top, left-bottom, center, right-top, right-bottom, custom array('x' =&gt; 100, 'y' =&gt; 200)</span>\n        ),\n        <span class=\"hljs-string\">'thumbs'</span>   =&gt; <span class=\"hljs-keyword\">array</span>(\n            <span class=\"hljs-string\">'tmb_'</span> =&gt; <span class=\"hljs-keyword\">array</span>(\n                <span class=\"hljs-string\">'width'</span> =&gt; <span class=\"hljs-number\">125</span>,\n                <span class=\"hljs-string\">'height'</span>=&gt; <span class=\"hljs-number\">70</span>,\n                <span class=\"hljs-string\">'type'</span>  =&gt; <span class=\"hljs-string\">'width'</span>,\n                <span class=\"hljs-string\">'crop'</span>  =&gt; <span class=\"hljs-string\">'left-top'</span>\n            )<span class=\"hljs-comment\">/*,\n            'mcr_' =&gt; array(\n                'width' =&gt; 50,\n                'height'=&gt; 50,\n                'type'  =&gt; 'width',\n                'crop'  =&gt; 'left-top'\n            )\n            */</span>\n        )\n    )\n);\n$sjConfig[<span class=\"hljs-string\">'lib_dir'</span>]  = $sjConfig[<span class=\"hljs-string\">'base_dir'</span>] . <span class=\"hljs-string\">'/lib/php'</span>;\n$sjConfig[<span class=\"hljs-string\">'base_url'</span>] = str_replace($_SERVER[<span class=\"hljs-string\">'DOCUMENT_ROOT'</span>], <span class=\"hljs-string\">''</span>, $sjConfig[<span class=\"hljs-string\">'base_dir'</span>]);\n$sjConfig[<span class=\"hljs-string\">'root_url'</span>] = str_replace($_SERVER[<span class=\"hljs-string\">'DOCUMENT_ROOT'</span>], <span class=\"hljs-string\">''</span>, $sjConfig[<span class=\"hljs-string\">'root'</span>]);\n$sjConfig[<span class=\"hljs-string\">'root_url'</span>] = rtrim($sjConfig[<span class=\"hljs-string\">'root_url'</span>], DIRECTORY_SEPARATOR);\n\n$max_size = ini_get(<span class=\"hljs-string\">'post_max_size'</span>);\n$unit = strtoupper(substr($max_size, <span class=\"hljs-number\">-1</span>));\n$multiplier = ($unit == <span class=\"hljs-string\">'M'</span> ? <span class=\"hljs-number\">1048576</span> : ($unit == <span class=\"hljs-string\">'K'</span> ? <span class=\"hljs-number\">1024</span> : ($unit == <span class=\"hljs-string\">'G'</span> ? <span class=\"hljs-number\">1073741824</span> : <span class=\"hljs-number\">1</span>)));\n\n$sjConfig[<span class=\"hljs-string\">'uploader'</span>][<span class=\"hljs-string\">'max_size'</span>] = <span class=\"hljs-number\">2048</span>; <span class=\"hljs-comment\">#$multiplier * (float)$max_size;</span>\n</code></pre>\n<h2 id=\"parametry\"><a name=\"parametry\" class=\"h-link\" href=\"#\"></a>Параметры</h2>\n<ul>\n<li>allowed_actions - список разрешенных действий для пользователя на данный момент доступны следующие: 'refresh','cut','copy','remove','paste','rename','perms','createDir','upload','download','dirInfo','transform'. При выполнение всех других действий пользователь получит в ответ &quot;Access denied&quot;</li>\n<li>charset - используемая кодировка (задается в в конструкторе JsHttpRequest)</li>\n<li>base_dir - корневая директория sjFilemanager-а</li>\n<li>root - корневой путь к рабочей папке</li>\n<li>uploader:max_size - максимальний загружаемый объем файлов</li>\n<li>uploader:allowed_types - разрешнные типы файлов для загрузки</li>\n<li>uploader:dynamic_name - если появляется конфликт имен файлов, например, файл с именем &quot;test.php&quot;, загрузив в папку файл с таким же именем получим test(1).php и т.д.</li>\n<li>uploader:override - если появляется конфликт имен файлов, то старый файл будет перезаписан новым</li>\n<li>uploader:images - параметры которые будут применяться ко всем загружаемым рисункам</li>\n<li>uploader:thumbs - создание thumbnail-ов для загружаемых картинок с определенным префиксом. Префикс это ключ массива. Количество элементов массива thumbs - не ограничено.</li>\n<li>lib_dir - путь к backend-у</li>\n<li>base_url - url относительно корня sjFilemanager-а</li>\n<li>root_url - url относительно рабочей папки</li>\n</ul>\n<h2 id=\"sj-filemanager-kak-plagin-dlya-symfony-1-4\"><a name=\"sj-filemanager-kak-plagin-dlya-symfony-1-4\" class=\"h-link\" href=\"#\"></a>sjFilemanager как плагин для Symfony 1.4</h2>\n<p>Все это хорошо, но есть проблема :). Ведь в таком случае кто-угодно будет иметь доступ к вашей рабочей папке! Есть несколько вариантов решения этой проблемы</p>\n<ul>\n<li>создать авторизации для sjFilemanager</li>\n<li>просто сделать проверку в config.php на наличие в сессии определенных данных</li>\n<li>вынести менеджер из корневой директории сайта, подправить config.php и подключить файл index.php в одном из своих контроллеров</li>\n</ul>\n<p>3 вариант мне нравится больше всего :) Сделаем плагин для популярного фреймворка Symfony 1.4.</p>\n<p>Имеем такую файловую структуру:</p>\n<pre><code class=\"hljs language-bash\">   |-lib\n   |-licenses\n   |-<span class=\"hljs-built_in\">test</span>\n   |-web\n   |---css\n   |---docs\n   |---img\n   |---js\n   |---index.php\n</code></pre>\n<p>Для начала переместим из web директории файл index.php в корень sjFilemanager-a. Создаем папки /config, /modules/sjFilemanager/actions и /modules/sjFilemanager/templates и /modules/sjFilemanager/config. Получаем:</p>\n<pre><code class=\"hljs language-bash\">   |-config\n   |-lib\n   |-licenses\n   |-modules\n   |---sjFilemanager\n   |-----actions\n   |-----config\n   |-----templates\n   |-<span class=\"hljs-built_in\">test</span>\n   |-web\n   |---css\n   |---docs\n   |---img\n   |---js\n   |-index.php\n</code></pre>\n<p>В директории /modules/sjFilemanager/config создем файл security.yml, следующего содержания:</p>\n<pre><code class=\"hljs language-cpp\"><span class=\"hljs-keyword\">default</span>:\n  is_secure: <span class=\"hljs-literal\">true</span>\n</code></pre>\n<p>Потом - файл routing.yml в директории /config:</p>\n<pre><code class=\"hljs language-javascript\">sjFilemanager:\n  url: <span class=\"hljs-regexp\">/sjFilemanager\n  param: { module: sjFilemanager, action: index }\n</span></code></pre>\n<p>Теперь очередь контроллера (actions.class.php), который будет обрабатывать все запросы. Идем в папку /modules/sjFilemanager/actions:</p>\n<pre><code class=\"hljs language-php\"><span class=\"hljs-meta\">&lt;?php</span>\n<span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">sjFilemanagerActions</span> <span class=\"hljs-keyword\">extends</span> <span class=\"hljs-title\">sfActions</span> </span>{\n    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">executeIndex</span><span class=\"hljs-params\">(sfWebRequest $request)</span> </span>{\n        $webDir = dirname(dirname(dirname(dirname(<span class=\"hljs-keyword\">__FILE__</span>))));\n        <span class=\"hljs-keyword\">require</span> $webDir . DIRECTORY_SEPARATOR . <span class=\"hljs-string\">'index.php'</span>;\n\n        <span class=\"hljs-keyword\">$this</span>-&gt;setLayout(<span class=\"hljs-keyword\">false</span>);\n        <span class=\"hljs-keyword\">return</span> sfView::NONE;\n    }\n}\n</code></pre>\n<p>Осталось только настроить и добавить на страницу наш файл-менеджер. Создаем файл _assets.php в /modules/sjFilemanager/templates, в нем будет содержатся конфигурация для frontend-a sjFilemanager-a:</p>\n<pre><code class=\"hljs language-php\"><span class=\"hljs-meta\">&lt;?php</span>\n$base_url = url_for(<span class=\"hljs-string\">'@sjFilemanager'</span>);\n$web_root = <span class=\"hljs-string\">'/sjFilemanagerPlugin'</span>;\nuse_stylesheet($web_root . <span class=\"hljs-string\">'/css/desktop.css'</span>);\nuse_javascript($web_root . <span class=\"hljs-string\">'/js/lang/lang_ru.js'</span>);\nuse_javascript($web_root . <span class=\"hljs-string\">'/js/pack/sjs.js'</span>);\nuse_javascript($web_root . <span class=\"hljs-string\">'/js/pack/swfupload.js'</span>);\nuse_javascript($web_root . <span class=\"hljs-string\">'/js/pack/sjFilemanager.js'</span>);\n<span class=\"hljs-meta\">?&gt;</span>\n&lt;script type=<span class=\"hljs-string\">\"text/javascript\"</span>&gt;\nsjs.ready(<span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span><span class=\"hljs-params\">()</span></span>{\n    FileManage.getInstance(<span class=\"hljs-keyword\">null</span>, <span class=\"hljs-string\">\"&lt;?php echo $base_url ?&gt;?tmpl=window&amp;show_actions=1\"</span>, {\n        dirUrl: <span class=\"hljs-string\">'&lt;?php echo $base_url ?&gt;'</span>,\n        actionUrl: <span class=\"hljs-string\">'&lt;?php echo $base_url ?&gt;'</span>,\n        actionSel: <span class=\"hljs-string\">'#sjFmActions'</span>,\n        events: {\n            onServerError: <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span><span class=\"hljs-params\">(js, html)</span> </span>{\n                FileManage.createWindow({\n                    id: this.id,\n                    title: $_LANG.TITLE_WARNING,\n                    content: <span class=\"hljs-string\">'&lt;p&gt;'</span> + js.response.msg + <span class=\"hljs-string\">'&lt;/p&gt;'</span>\n                });\n            }\n        },\n        upload: {\n            object:  SWFUpload,\n            onReadyEventName: <span class=\"hljs-string\">'file_dialog_complete_handler'</span>,\n            flash_url : <span class=\"hljs-string\">\"&lt;?php echo $web_root ?&gt;/js/swfupload/swfupload.swf\"</span>,\n            file_post_name:<span class=\"hljs-string\">'files'</span>,\n            custom_settings : {\n                progressTarget : <span class=\"hljs-string\">\"sjFmUploadProgress\"</span>\n            },\n            file_size_limit : <span class=\"hljs-string\">\"10MB\"</span>,\n            file_types : <span class=\"hljs-string\">\"*.*\"</span>,\n            file_types_description : <span class=\"hljs-string\">\"All Files\"</span>,\n            file_upload_limit : <span class=\"hljs-number\">100</span>,\n            file_queue_limit : <span class=\"hljs-number\">0</span>,\n\n            button_text_left_padding: <span class=\"hljs-number\">5</span>,\n            button_text_top_padding: <span class=\"hljs-number\">1</span>,\n            button_image_url: <span class=\"hljs-string\">\"/&lt;?php echo $web_root ?&gt;/js/swfupload/sbtn.png\"</span>,\n            button_placeholder_id: <span class=\"hljs-string\">\"sjFmButtonPlaceHolder\"</span>,\n            button_text: <span class=\"hljs-string\">'&lt;span class=\"submit\"&gt;'</span> + $_LANG.UPLOAD_BTN_TEXT + <span class=\"hljs-string\">'&lt;/span&gt;'</span>,\n            button_width: <span class=\"hljs-string\">\"65\"</span>,\n            button_text_style: <span class=\"hljs-string\">\".submit { font-size: 11; color:#000000; font-family:Tahoma, Arial, serif; }\"</span>,\n            button_height: <span class=\"hljs-string\">\"20\"</span>,\n            file_queued_handler: fileQueued,\n            file_queue_error_handler: fileQueueError,\n            upload_start_handler: uploadStart,\n            upload_progress_handler: uploadProgress,\n            upload_error_handler: uploadError,\n            upload_success_handler: uploadSuccess\n        }\n    });\n});\n&lt;/script&gt;\n&lt;div id=<span class=\"hljs-string\">\"sjWindowTmpl\"</span> style=<span class=\"hljs-string\">\"display:none\"</span>&gt;\n    &lt;div <span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span>=\"<span class=\"hljs-title\">sjs_wtop</span>\"&gt;\n    \t&lt;<span class=\"hljs-title\">div</span> <span class=\"hljs-title\">class</span>=\"<span class=\"hljs-title\">sjs_wltitle</span>\"&gt;&lt;/<span class=\"hljs-title\">div</span>&gt;\n    \t&lt;<span class=\"hljs-title\">div</span> <span class=\"hljs-title\">class</span>=\"<span class=\"hljs-title\">sjs_wrtitle</span>\"&gt;&lt;/<span class=\"hljs-title\">div</span>&gt;\n        &lt;<span class=\"hljs-title\">div</span> <span class=\"hljs-title\">class</span>=\"<span class=\"hljs-title\">sjs_wtitle</span>\"&gt;<span class=\"hljs-title\">Window</span> <span class=\"hljs-title\">title</span>&lt;/<span class=\"hljs-title\">div</span>&gt;\n    \t&lt;<span class=\"hljs-title\">img</span> <span class=\"hljs-title\">src</span>=\"&lt;?<span class=\"hljs-title\">php</span> <span class=\"hljs-title\">echo</span> $<span class=\"hljs-title\">base_url</span> ?&gt;<span class=\"hljs-title\">img</span>/<span class=\"hljs-title\">load</span>.<span class=\"hljs-title\">gif</span>\" <span class=\"hljs-title\">alt</span>=\"\" <span class=\"hljs-title\">class</span>=\"<span class=\"hljs-title\">upload_img</span>\" /&gt;\n        &lt;<span class=\"hljs-title\">div</span> <span class=\"hljs-title\">class</span>=\"<span class=\"hljs-title\">sjs_waction</span>\"&gt;\n            &lt;<span class=\"hljs-title\">a</span> <span class=\"hljs-title\">href</span>=\"#\" <span class=\"hljs-title\">class</span>=\"<span class=\"hljs-title\">minimize</span>\" <span class=\"hljs-title\">onclick</span>=\"<span class=\"hljs-title\">return</span> <span class=\"hljs-title\">false</span>;\" <span class=\"hljs-title\">tabindex</span>=\"0\"&gt;&lt;/<span class=\"hljs-title\">a</span>\n            &gt;&lt;<span class=\"hljs-title\">a</span> <span class=\"hljs-title\">href</span>=\"#\" <span class=\"hljs-title\">class</span>=\"<span class=\"hljs-title\">maximize</span>\" <span class=\"hljs-title\">onclick</span>=\"<span class=\"hljs-title\">return</span> <span class=\"hljs-title\">false</span>;\" <span class=\"hljs-title\">tabindex</span>=\"0\"&gt;&lt;/<span class=\"hljs-title\">a</span>\n            &gt;&lt;<span class=\"hljs-title\">a</span> <span class=\"hljs-title\">href</span>=\"#\" <span class=\"hljs-title\">class</span>=\"<span class=\"hljs-title\">close</span>\" <span class=\"hljs-title\">onclick</span>=\"<span class=\"hljs-title\">return</span> <span class=\"hljs-title\">false</span>;\" <span class=\"hljs-title\">tabindex</span>=\"0\"&gt;&lt;/<span class=\"hljs-title\">a</span>&gt;\n        &lt;/<span class=\"hljs-title\">div</span>&gt;\n    &lt;/<span class=\"hljs-title\">div</span>&gt;\n    &lt;<span class=\"hljs-title\">div</span> <span class=\"hljs-title\">class</span>=\"<span class=\"hljs-title\">window_main</span>\"&gt;\n        &lt;<span class=\"hljs-title\">div</span> <span class=\"hljs-title\">class</span>=\"<span class=\"hljs-title\">bbottom</span>\"&gt;&lt;/<span class=\"hljs-title\">div</span>&gt;\n        &lt;<span class=\"hljs-title\">div</span> <span class=\"hljs-title\">class</span>=\"<span class=\"hljs-title\">bleft</span>\"&gt;&lt;/<span class=\"hljs-title\">div</span>&gt;\n        &lt;<span class=\"hljs-title\">div</span> <span class=\"hljs-title\">class</span>=\"<span class=\"hljs-title\">bright</span>\"&gt;&lt;/<span class=\"hljs-title\">div</span>&gt;\n        &lt;<span class=\"hljs-title\">div</span> <span class=\"hljs-title\">class</span>=\"<span class=\"hljs-title\">sjs_wcontent</span>\"&gt;&lt;/<span class=\"hljs-title\">div</span>&gt;\n    &lt;/<span class=\"hljs-title\">div</span>&gt;\n&lt;/<span class=\"hljs-title\">div</span>&gt;\n</span></code></pre>\n<p>Сконфигурировав все по своему желанию, можна использовать этот файл в любом модуле, используя include_partial('sjFilemanager/assets') или просто скопировать этот файл в нужное место. Кто захочет также можна перенести конфигурацию в app.yml.</p>\n<p>Осталось сконфигурировать backend. Открываем /lib/php/config.php и меням несколько строк:</p>\n<pre><code class=\"hljs language-php\">$sjConfig = <span class=\"hljs-keyword\">array</span>(\n...................................................\n    <span class=\"hljs-string\">'base_dir'</span> =&gt; dirname(dirname(dirname(<span class=\"hljs-keyword\">__FILE__</span>))),\n    <span class=\"hljs-string\">'root'</span> =&gt; $_SERVER[<span class=\"hljs-string\">'DOCUMENT_ROOT'</span>] . <span class=\"hljs-string\">'/uploads'</span>,\n    <span class=\"hljs-comment\">/** <span class=\"hljs-doctag\">@var</span> $this sfWebController */</span>\n    <span class=\"hljs-string\">'base_url'</span> =&gt; <span class=\"hljs-keyword\">$this</span>-&gt;genUrl(<span class=\"hljs-string\">'@sjFilemanagerPlugin'</span>) <span class=\"hljs-comment\"># '/sjFilemanagerPlugin'</span>\n.....................................................\n);\n</code></pre>\n<p>Не забываем, что новый плагин нужно включить в конфигурации вашого проекта или приложения следующим образом:</p>\n<pre><code class=\"hljs language-php\"><span class=\"hljs-keyword\">$this</span>-&gt;enablePlugins(<span class=\"hljs-keyword\">array</span>(\n     <span class=\"hljs-string\">'sjFilemanagerPlugin'</span>\n));\n</code></pre>\n<p>Теперь включаем модуль sjFilemanager модуль в <strong>settings.yml</strong> вашего приложения и все!</p>\n<p>Готовый результат можна скачать <a href=\"/media/assets/sjFilemanagerPlugin.zip\" download=\"sjFilemanagerPlugin.zip\">ЗДЕСЬ</a>.</p>\n<pre><code class=\"hljs language-php\">base_dir\n</code></pre>","headings":[["bazovye-nastrojki","Базовые настройки"],["parametry","Параметры"],["sj-filemanager-kak-plagin-dlya-symfony-1-4","sjFilemanager как плагин для Symfony 1.4"]],"id":"sjfilemanager-konfighuriruem-failovyi-menedzher"}