{"title":"Как включить Google reCaptcha в Magento 1.x","summary":"В прошлой статье я писал о том, зачем нужна капча и как подключить стандартную\nкапчу в Magento. Здесь же, хочу рассмотреть вариант на много более\nдружественного подхода к пользователям, а именно подключить Google reCaptcha -\nобычный чекбокс!\n","author":"sstotskyi","categories":["backend","important"],"createdAt":"2017-05-22T08:00:00.000Z","meta":{"keywords":["magento","spam","recaptcha","спам"]},"alias":"kak-vklyuchit-google-recaptcha-v-magento-1x","content":"<p>Если говорить о капче простыми словами, то она защищает сайт от роботов. Но если сложность капчи очень большая, то она будет препятствием между Вашими пользователями и сайтом.</p>\n<h2 id=\"vklyuchaem-google-re-captcha\"><a name=\"vklyuchaem-google-re-captcha\" class=\"h-link\" href=\"#\"></a>Включаем Google reCaptcha</h2>\n<p>К счастью, существует <a href=\"https://www.magentocommerce.com/magento-connect/recaptcha-1.html\" target=\"_blank\" rel=\"noopener nofollow\">модуль для интеграции Google reCaptcha в Magento 1.x</a>. Давайте его подключим через Magento Connect Manager.</p>\n<p>После успешной установки, настройки для капчи появятся в Система &gt; Конфигурация &gt; Google API &gt; Google reCaptcha</p>\n<p><img src=\"/media/assets/recaptcha.png\" alt=\"Настройки Google Recaptcha Magento\" width=\"801\" height=\"594\"></p>\n<p>Как видно из скриншота, капчу можно включить для 6 форм:</p>\n<ul>\n<li>Контактная форма</li>\n<li>Форма отзыва</li>\n<li>Форма регистрации</li>\n<li>Форма отправка товара другу</li>\n<li>Форма логина</li>\n<li>Форма восстановления пароля</li>\n</ul>\n<p>Для теста, давайте подключим капчу на форму логина. Захожу на форму логина - капчи не вижу, в таких случаях в первую очередь я проверяю JavaScript Console в Chrome Developer Tools и вижу ошибку:</p>\n<p><img src=\"/media/assets/recaptcha-login.png\" alt=\"Google Recaptcha ошибка в консоли magento\" width=\"1109\" height=\"507\"></p>\n<p>Ошибка говорит о том, что пропущен обязательный параметр sitekey.</p>\n<h2 id=\"registracziya-google-re-captcha\"><a name=\"registracziya-google-re-captcha\" class=\"h-link\" href=\"#\"></a>Регистрация Google reCaptcha</h2>\n<p>Давайте вернемся в настройки. И действительно, поля Site Key и Site Secret пусты, к счастью под ними есть ссылка, жму на ссылку и отрывается страница регистрации reCaptcha (если Вы не были залогинены в Google, то он попросит Вас войти).</p>\n<p><img src=\"/media/assets/recaptcha-register.png\" alt=\"Google Recaptcha register new one\" width=\"580\" height=\"598\"></p>\n<p>Нужно указать всего несколько полей:</p>\n<ul>\n<li>Имя - все что придет Вам на ум, но лучше называть по имени сайта или группы сайтов для которых вы будете использовать эту капчу</li>\n<li>Тип - reCaptcha v2</li>\n<li>Список доменов - домены, для которых вы создаете капчу. У меня это localhost, так как я все делаю на тестовом сайте</li>\n</ul>\n<p>Принимаю условия пользовательского соглашения и жму кнопку Register.</p>\n<p>На следующей странице уже сразу вижу нужные мне поля: Site Key и Secret Key.</p>\n<p><img src=\"/media/assets/recaptcha-creds.png\" alt=\"Google Recaptcha доступы magento\" width=\"925\" height=\"204\"></p>\n<p>Копирую их в настройки админки и сохраняю. Захожу обратно на страницу логину и капча там где должна быть :)</p>\n<p><img src=\"/media/assets/login-recaptcha.png\" alt=\"Google Recaptcha magento форма логина\" width=\"494\" height=\"404\"></p>\n<h2 id=\"kommentarii-i-re-captcha\"><a name=\"kommentarii-i-re-captcha\" class=\"h-link\" href=\"#\"></a>Комментарии и reCaptcha</h2>\n<p>Тот кто читал <app-link to=\"page\" params=\"{&quot;id&quot;:&quot;php_and_somethings/show-129-kak-vklyuchit-kapchu-v-magento-1x&quot;}\">предыдущую статью об обычной капче</app-link>, тот знает, что затеял я все это, чтобы защитить форму комментариев. Как и в стандартном модуле, этот предоставляет возможность расширять набор форм для защиты. К сожалению, это сделано не так просто как в случае с обычной капчей, через настройки, а через отдельное событие. Поэтому нам <app-link to=\"page\" params=\"{&quot;id&quot;:&quot;php_and_somethings/show-6-magento-backend---sozdanie-crud-modulya&quot;}\">нужен свой Magento модуль</app-link> с обработчиком события studioforty9_recaptcha_routes.</p>\n<pre><code class=\"hljs language-xml\"><span class=\"hljs-meta\">&lt;?xml version=\"1.0\"?&gt;</span>\n<span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">config</span>&gt;</span>\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">modules</span>&gt;</span>\n        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">FI_Recaptcha</span>&gt;</span>\n            <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">version</span>&gt;</span>1.0.0.0<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">version</span>&gt;</span>\n        <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">FI_Recaptcha</span>&gt;</span>\n    <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">modules</span>&gt;</span>\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">global</span>&gt;</span>\n        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">models</span>&gt;</span>\n            <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">FI_Recaptcha</span>&gt;</span>\n                <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">class</span>&gt;</span>FI_Recaptcha_Model<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">class</span>&gt;</span>\n            <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">FI_Recaptcha</span>&gt;</span>\n        <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">models</span>&gt;</span>\n        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">events</span>&gt;</span>\n            <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">studioforty9_recaptcha_routes</span>&gt;</span>\n                <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">observers</span>&gt;</span>\n                    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">FI_Recaptcha</span>&gt;</span>\n                        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">class</span>&gt;</span>FI_Recaptcha/observer<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">class</span>&gt;</span>\n                        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">method</span>&gt;</span>addRecaptchaRoutes<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">method</span>&gt;</span>\n                    <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">FI_Recaptcha</span>&gt;</span>\n                <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">observers</span>&gt;</span>\n            <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">studioforty9_recaptcha_routes</span>&gt;</span>\n        <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">events</span>&gt;</span>\n    <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">global</span>&gt;</span>\n<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">config</span>&gt;</span>\n</code></pre>\n<p>И теперь добавляем модель Observer.php в модуль:</p>\n<pre><code class=\"hljs language-php\"><span class=\"hljs-meta\">&lt;?php</span>\n<span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">FI_Recaptcha_Model_Observer</span> </span>{\n  <span class=\"hljs-keyword\">public</span> <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">addRecaptchaRoutes</span><span class=\"hljs-params\">(Varien_Event_Observer $observer)</span>\n  </span>{\n    $routes = $observer-&gt;getEvent()-&gt;getRoutes();\n    $routes-&gt;add(<span class=\"hljs-string\">'blog_post_view'</span>, Mage::helper(<span class=\"hljs-string\">'blog'</span>)-&gt;__(<span class=\"hljs-string\">'Comment Form'</span>));\n\n    <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">$this</span>;\n  }\n}\n</code></pre>\n<p>Метод $routes-&gt;add первым параметром принимает полное имя контроллера (его можно получить при помощи метода getFullActionName()), а вторым - название формы. Обновляем кэш и идем в конфигурацию модуля reCaptcha:</p>\n<p><img src=\"/media/assets/recapcha-comment-form.png\" alt=\"Magento recaptcha дополнительная форма комментариев\" width=\"768\" height=\"527\"></p>\n<p>Видим, что появилась дополнительная форма Comment Form, включаем капчу и для нее. Следующим этапом будет обновление настроек layout. Для этого добавим новую секцию в config.xml</p>\n<pre><code class=\"hljs language-xml\"><span class=\"hljs-comment\">&lt;!-- .... --&gt;</span>\n<span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">frontend</span>&gt;</span>\n  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">layout</span>&gt;</span>\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">updates</span>&gt;</span>\n      <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">studioforty9_recaptcha</span>&gt;</span>\n        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">file</span>&gt;</span>fi_recaptcha.xml<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">file</span>&gt;</span>\n      <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">studioforty9_recaptcha</span>&gt;</span>\n    <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">updates</span>&gt;</span>\n  <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">layout</span>&gt;</span>\n<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">frontend</span>&gt;</span>\n<span class=\"hljs-comment\">&lt;!-- .... --&gt;</span>\n</code></pre>\n<p>Теперь в файле fi_recaptcha.xml (который нужно положить в активную тему или в base/layout), добавляем блок для recaptcha</p>\n<pre><code class=\"hljs language-xml\"><span class=\"hljs-meta\">&lt;?xml version=\"1.0\"?&gt;</span>\n<span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">layout</span> <span class=\"hljs-attr\">version</span>=<span class=\"hljs-string\">\"0.1.0\"</span>&gt;</span>\n  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">blog_post_view</span>&gt;</span>\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">reference</span> <span class=\"hljs-attr\">name</span>=<span class=\"hljs-string\">\"comments.form\"</span>&gt;</span>\n        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">block</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"studioforty9_recaptcha/explicit\"</span> <span class=\"hljs-attr\">name</span>=<span class=\"hljs-string\">\"captcha\"</span> <span class=\"hljs-attr\">template</span>=<span class=\"hljs-string\">\"studioforty9/recaptcha/explicit.phtml\"</span> /&gt;</span>\n    <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">reference</span>&gt;</span>\n  <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">blog_post_view</span>&gt;</span>\n<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">layout</span>&gt;</span>\n</code></pre>\n<p>И теперь выводим его в шаблоне формы комментария:</p>\n<pre><code class=\"hljs language-php\"><span class=\"hljs-meta\">&lt;?php</span> <span class=\"hljs-keyword\">if</span> ($captchaHtml = <span class=\"hljs-keyword\">$this</span>-&gt;getChildHtml(<span class=\"hljs-string\">'captcha'</span>)): <span class=\"hljs-meta\">?&gt;</span>\n&lt;ul <span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span>=\"<span class=\"hljs-title\">form</span>-<span class=\"hljs-title\">group</span>\"&gt;&lt;?<span class=\"hljs-title\">php</span> <span class=\"hljs-title\">echo</span> $<span class=\"hljs-title\">captchaHtml</span> ?&gt;&lt;/<span class=\"hljs-title\">ul</span>&gt;\n&lt;?<span class=\"hljs-title\">php</span> <span class=\"hljs-title\">endif</span> ?&gt;\n</span></code></pre>\n<p>В результате получается вот это:</p>\n<p><img src=\"/media/assets/recaptcha-comment-protected.png\" alt=\"Magento Recaptcha форма комментариев\" width=\"684\" height=\"518\"></p>\n<p>По аналогии можно добавить reCaptcha на любую другую форму.</p>","headings":[["vklyuchaem-google-re-captcha","Включаем Google reCaptcha"],["registracziya-google-re-captcha","Регистрация Google reCaptcha"],["kommentarii-i-re-captcha","Комментарии и reCaptcha"]],"id":"kak-vklyuchit-google-recaptcha-v-magento-1x"}