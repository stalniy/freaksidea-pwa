{"title":"Magento - добавляем комментарий к заказу","summary":"Очень часто, при  заказе продуктов в интернет магазине хочется оставить\nкомментарий к заказу. Чтобы написать, например: у меня 7 этаж, код на дверях\n787. Или спросить когда товар появится в наличии или появится вообще.\n\nТакую задачу пришлось решать мне на базе Magento\n","author":"sstotskyi","categories":["backend","important"],"createdAt":"2011-09-30T11:55:00.000Z","meta":{"keywords":["magento","комментарий к заказу"]},"alias":"magento---dobavlyaem-kommentarij-k-zakazu","content":"<p>Есть несколько дополнений к Magento, которые делают возможным комментировать заказ, но в большинстве они просто добавляют новый атрибут к сущности ордера. Напрашивается вопрос зачем? Ведь в Magento уже есть достаточно хороший механизм комментирования.</p>\n<h2 id=\"ishhem-gde-priyutitsya\"><a name=\"ishhem-gde-priyutitsya\" class=\"h-link\" href=\"#\"></a>Ищем где приютится</h2>\n<p>Благодаря восхитительным возможностям Linux команды grep, было установлено существование события <strong>checkout_type_onepage_save_order</strong>. Чтобы установить комментарий на заказ, можно использовать код</p>\n<pre><code class=\"hljs language-php\">$order-&gt;setCustomerNote(<span class=\"hljs-string\">'мой первый комментарий'</span>);\n<span class=\"hljs-comment\"># или же</span>\n$order-&gt;addStatusToHistory($order-&gt;getStatus(), <span class=\"hljs-string\">'мой первый комментарий'</span>, <span class=\"hljs-keyword\">false</span>);\n</code></pre>\n<p>Первый вариант более удобен, тем что после оформления заказа в отправленном письме (о новом заказе) Magento автоматически включит комментарий в текст сообщения.</p>\n<h2 id=\"pristupaem-k-rabote\"><a name=\"pristupaem-k-rabote\" class=\"h-link\" href=\"#\"></a>Приступаем к работе</h2>\n<p>Для начала нужно <app-link to=\"page\" params=\"{&quot;id&quot;:&quot;php_and_somethings/show-5-magento-sozdanie-crud-modulia&quot;}\">создать модуль</app-link> с такой структурой</p>\n<pre><code class=\"hljs language-bash\">|-app\n|---code\n|-----<span class=\"hljs-built_in\">local</span>\n|-------Freaks\n|---------OrderComments\n|-----------etc\n|-------------config.xml\n|-----------Model\n|-------------Observer.php\n|---design\n|-----frontend\n|-------default\n|---------default\n|-----------template\n|-------------checkout\n|---------------onepage\n|-----------------agreements.phtml\n|---etc\n|-----modules\n|-------Freaks_OrderComments.xml\n</code></pre>\n<p>В файле конфигурации ничего особенного, за исключением</p>\n<pre><code class=\"hljs language-xml\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">frontend</span>&gt;</span>\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">events</span>&gt;</span>\n        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">checkout_type_onepage_save_order</span>&gt;</span>\n            <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">observers</span>&gt;</span>\n                <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">Freaks_OrderComments</span>&gt;</span>\n                    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">class</span>&gt;</span>freaks_ordercomments/observer<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">class</span>&gt;</span>\n                    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">method</span>&gt;</span>addOrderComment<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">method</span>&gt;</span>\n                <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">Freaks_OrderComments</span>&gt;</span>\n            <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">observers</span>&gt;</span>\n        <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">checkout_type_onepage_save_order</span>&gt;</span>\n    <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">events</span>&gt;</span>\n.........................................................................................................\n<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">frontend</span>&gt;</span>\n</code></pre>\n<p>Это значит, что при возникновении события <strong>checkout_type_onepage_save_order</strong>, нужно вызвать метод обсервера <strong>addOrderComment</strong>.</p>\n<p>Сам обсервер очень прост. Берем заказ из события, устанавливаем комментарий из запроса посредством выше упомянутых средств и все</p>\n<pre><code class=\"hljs language-php\"><span class=\"hljs-meta\">&lt;?php</span>\n<span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">Freaks_OrderComments_Model_Observer</span>\n</span>{\n    <span class=\"hljs-comment\">/**\n     * Add a customer order comment when the order is placed.\n     * Listen \"checkout_type_onepage_save_order\" event\n     *\n     * <span class=\"hljs-doctag\">@param</span> Varien_Event_Observer $observer\n     * <span class=\"hljs-doctag\">@return</span> Freaks_OrderComments_Model_Observer\n     */</span>\n    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">addOrderComment</span><span class=\"hljs-params\">(Varien_Event_Observer $observer)</span>\n    </span>{\n        $order = $observer-&gt;getEvent()-&gt;getOrder();\n        $request = Mage::app()-&gt;getRequest();\n\n        $comments = strip_tags($request-&gt;getParam(<span class=\"hljs-string\">'customer_comment'</span>));\n\n        <span class=\"hljs-keyword\">if</span>(!<span class=\"hljs-keyword\">empty</span>($comments)){\n            $order-&gt;setCustomerNote($comments);\n        }\n\n        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">$this</span>;\n    }\n}\n</code></pre>\n<p>Чтобы комментарий отправлялся на сервер, нужно переопределить шаблон платежных соглашений. Просто допишем в него еще одно поле textarea</p>\n<pre><code class=\"hljs language-php\">&lt;form action=<span class=\"hljs-string\">\"\"</span> id=<span class=\"hljs-string\">\"checkout-agreements\"</span> onsubmit=<span class=\"hljs-string\">\"return false;\"</span>&gt;\n<span class=\"hljs-meta\">&lt;?php</span> <span class=\"hljs-keyword\">if</span> (<span class=\"hljs-keyword\">$this</span>-&gt;getAgreements()): <span class=\"hljs-meta\">?&gt;</span>\n    &lt;ol <span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span>=\"<span class=\"hljs-title\">checkout</span>-<span class=\"hljs-title\">agreements</span>\"&gt;\n    &lt;?<span class=\"hljs-title\">php</span> <span class=\"hljs-title\">foreach</span> ($<span class=\"hljs-title\">this</span>-&gt;<span class=\"hljs-title\">getAgreements</span>() <span class=\"hljs-title\">as</span> $<span class=\"hljs-title\">_a</span>): ?&gt;\n        &lt;<span class=\"hljs-title\">li</span>&gt;\n            &lt;<span class=\"hljs-title\">div</span> <span class=\"hljs-title\">class</span>=\"<span class=\"hljs-title\">agreement</span>-<span class=\"hljs-title\">content</span>\"&lt;?<span class=\"hljs-title\">php</span> <span class=\"hljs-title\">echo</span> ($<span class=\"hljs-title\">_a</span>-&gt;<span class=\"hljs-title\">getContentHeight</span>() ? ' <span class=\"hljs-title\">style</span>=\"<span class=\"hljs-title\">height</span>:' . $<span class=\"hljs-title\">_a</span>-&gt;<span class=\"hljs-title\">getContentHeight</span>() . '\"' : '')?&gt;&gt;\n                &lt;?<span class=\"hljs-title\">php</span> <span class=\"hljs-title\">if</span> ($<span class=\"hljs-title\">_a</span>-&gt;<span class=\"hljs-title\">getIsHtml</span>()):?&gt;\n                    &lt;?<span class=\"hljs-title\">php</span> <span class=\"hljs-title\">echo</span> $<span class=\"hljs-title\">_a</span>-&gt;<span class=\"hljs-title\">getContent</span>() ?&gt;\n                &lt;?<span class=\"hljs-title\">php</span> <span class=\"hljs-title\">else</span>:?&gt;\n                    &lt;?<span class=\"hljs-title\">php</span> <span class=\"hljs-title\">echo</span> <span class=\"hljs-title\">nl2br</span>($<span class=\"hljs-title\">this</span>-&gt;<span class=\"hljs-title\">htmlEscape</span>($<span class=\"hljs-title\">_a</span>-&gt;<span class=\"hljs-title\">getContent</span>())) ?&gt;\n                &lt;?<span class=\"hljs-title\">php</span> <span class=\"hljs-title\">endif</span>; ?&gt;\n            &lt;/<span class=\"hljs-title\">div</span>&gt;\n            &lt;<span class=\"hljs-title\">p</span> <span class=\"hljs-title\">class</span>=\"<span class=\"hljs-title\">agree</span>\"&gt;\n                &lt;<span class=\"hljs-title\">input</span> <span class=\"hljs-title\">type</span>=\"<span class=\"hljs-title\">checkbox</span>\" <span class=\"hljs-title\">id</span>=\"<span class=\"hljs-title\">agreement</span>-&lt;?<span class=\"hljs-title\">php</span> <span class=\"hljs-title\">echo</span> $<span class=\"hljs-title\">_a</span>-&gt;<span class=\"hljs-title\">getId</span>()?&gt;\" <span class=\"hljs-title\">name</span>=\"<span class=\"hljs-title\">agreement</span>[&lt;?<span class=\"hljs-title\">php</span> <span class=\"hljs-title\">echo</span> $<span class=\"hljs-title\">_a</span>-&gt;<span class=\"hljs-title\">getId</span>()?&gt;]\" <span class=\"hljs-title\">value</span>=\"1\" <span class=\"hljs-title\">title</span>=\"&lt;?<span class=\"hljs-title\">php</span> <span class=\"hljs-title\">echo</span> $<span class=\"hljs-title\">this</span>-&gt;<span class=\"hljs-title\">htmlEscape</span>($<span class=\"hljs-title\">_a</span>-&gt;<span class=\"hljs-title\">getCheckboxText</span>()) ?&gt;\" <span class=\"hljs-title\">class</span>=\"<span class=\"hljs-title\">checkbox</span>\" /&gt;&lt;<span class=\"hljs-title\">label</span> <span class=\"hljs-title\">for</span>=\"<span class=\"hljs-title\">agreement</span>-&lt;?<span class=\"hljs-title\">php</span> <span class=\"hljs-title\">echo</span> $<span class=\"hljs-title\">_a</span>-&gt;<span class=\"hljs-title\">getId</span>()?&gt;\"&gt;&lt;?<span class=\"hljs-title\">php</span> <span class=\"hljs-title\">echo</span> $<span class=\"hljs-title\">this</span>-&gt;<span class=\"hljs-title\">htmlEscape</span>($<span class=\"hljs-title\">_a</span>-&gt;<span class=\"hljs-title\">getCheckboxText</span>()) ?&gt;&lt;/<span class=\"hljs-title\">label</span>&gt;\n            &lt;/<span class=\"hljs-title\">p</span>&gt;\n        &lt;/<span class=\"hljs-title\">li</span>&gt;\n    &lt;?<span class=\"hljs-title\">php</span> <span class=\"hljs-title\">endforeach</span> ?&gt;\n    &lt;/<span class=\"hljs-title\">ol</span>&gt;\n&lt;?<span class=\"hljs-title\">php</span> <span class=\"hljs-title\">endif</span> ?&gt;\n    &lt;<span class=\"hljs-title\">ol</span> <span class=\"hljs-title\">class</span>=\"<span class=\"hljs-title\">checkout</span>-<span class=\"hljs-title\">comments</span>\" <span class=\"hljs-title\">style</span>=\"<span class=\"hljs-title\">padding</span>-<span class=\"hljs-title\">left</span>:9<span class=\"hljs-title\">px</span>;\"&gt;\n        &lt;<span class=\"hljs-title\">li</span>&gt;\n            &lt;<span class=\"hljs-title\">label</span> <span class=\"hljs-title\">for</span>=\"<span class=\"hljs-title\">customer_comment</span>\"&gt;&lt;?<span class=\"hljs-title\">php</span> <span class=\"hljs-title\">echo</span> $<span class=\"hljs-title\">this</span>-&gt;<span class=\"hljs-title\">__</span>('<span class=\"hljs-title\">Comment</span>') ?&gt;&lt;/<span class=\"hljs-title\">label</span>&gt;\n            &lt;<span class=\"hljs-title\">br</span>/&gt;&lt;<span class=\"hljs-title\">textarea</span> <span class=\"hljs-title\">name</span>=\"<span class=\"hljs-title\">customer_comment</span>\" <span class=\"hljs-title\">id</span>=\"<span class=\"hljs-title\">customer_comment</span>\" <span class=\"hljs-title\">style</span>=\"<span class=\"hljs-title\">width</span>:440<span class=\"hljs-title\">px</span>; <span class=\"hljs-title\">height</span>:100<span class=\"hljs-title\">px</span>\"&gt;&lt;/<span class=\"hljs-title\">textarea</span>&gt;\n        &lt;/<span class=\"hljs-title\">li</span>&gt;\n    &lt;/<span class=\"hljs-title\">ol</span>&gt;\n&lt;/<span class=\"hljs-title\">form</span>&gt;\n</span></code></pre>\n<p>Вот что получилось у меня</p>\n<p><img src=\"/media/assets/order_comment.jpg\" alt=\"Magento комментарий к заказу onepage checkout\" width=\"400\" height=\"291\"></p>\n<p>Не забываем, что комментарий появится только на странице OnePage чекаута. Скачать готовое решение можно <app-link to=\"page\" params=\"{&quot;id&quot;:&quot;backend/2011-09/magento-dobavlyaem-kommentarij-k-zakazu/Freaks_OrderComments.zip&quot;}\">здесь</app-link></p>","headings":[["ishhem-gde-priyutitsya","Ищем где приютится"],["pristupaem-k-rabote","Приступаем к работе"]],"id":"magento-dobavlyaem-kommentarij-k-zakazu"}