{"title":"Magento EAV или дружим цитату с продуктом.","summary":"В этой статье я покажу, как связать любой модуль (на примере  Freaks_Quotes) с\nпродуктом в Magento, через EAV модуль\n","author":"sstotskyi","categories":["backend","important"],"createdAt":"2011-02-12T11:22:00.000Z","meta":{"keywords":["magento","eav"]},"alias":"magento-eav-ili-druzhim-tsitatu-s-produktom","content":"<p>В этой статье мы свяжем цитаты и продукты в Magento, используя EAV модуль. Предыдущую версию модуля можно скачать <app-link to=\"page\" params=\"{&quot;id&quot;:&quot;backend/2011-02/magento-eav-ili-druzhim-tsitatu-s-produktom/Freak_Quotes_With_Image.zip&quot;}\">ЗДЕСЬ</app-link>.</p>\n<h2 id=\"sapaem-vazony\"><a name=\"sapaem-vazony\" class=\"h-link\" href=\"#\"></a>Сапаем вазоны</h2>\n<p>Для начала нам нужно создать атрибут для продуктов, в котором будет сохранятся <strong>ID</strong> цитаты. Управление атрибутами реализовано в <em>Mage_Eav_Model_Entity_Setup</em>, поэтому нужно изменить <strong>config.xml</strong>. Открываем этот файл и добавляем всего одну строчку</p>\n<pre><code class=\"hljs language-xml\">..........................................\n        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">resources</span>&gt;</span>\n            <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">quotes_setup</span>&gt;</span>\n                <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">setup</span>&gt;</span>\n                    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">module</span>&gt;</span>Freaks_Quotes<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">module</span>&gt;</span>\n                    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">class</span>&gt;</span>Mage_Eav_Model_Entity_Setup<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">class</span>&gt;</span>\n                <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">setup</span>&gt;</span>\n                <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">connection</span>&gt;</span>\n                    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">use</span>&gt;</span>core_setup<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">use</span>&gt;</span>\n                <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">connection</span>&gt;</span>\n            <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">quotes_setup</span>&gt;</span>\n................................................\n</code></pre>\n<p>Теперь напишем сам upgrade. Создаем файл <strong>app/code/local/Freaks/Quotes/sql/quotes_setup/mysql4-upgrade-0.3.0-0.4.0.php</strong></p>\n<pre><code class=\"hljs language-php\"><span class=\"hljs-meta\">&lt;?php</span>\n$installer = <span class=\"hljs-keyword\">$this</span>;\n$installer-&gt;startSetup();\n\n$installer-&gt;addAttribute(<span class=\"hljs-string\">'catalog_product'</span>, <span class=\"hljs-string\">'freaks_quotes_id'</span>, <span class=\"hljs-keyword\">array</span>(\n    <span class=\"hljs-comment\">#'position'          =&gt; 1,</span>\n    <span class=\"hljs-comment\">#'user_defined'      =&gt; 1,</span>\n    <span class=\"hljs-comment\">#'searchable'        =&gt; 0,</span>\n    <span class=\"hljs-comment\">#'filterable'        =&gt; 0,</span>\n    <span class=\"hljs-comment\">#'comparable'        =&gt; 0,</span>\n    <span class=\"hljs-comment\">#'visible_on_front'  =&gt; 1,</span>\n    <span class=\"hljs-comment\">#'visible_in_advanced_search' =&gt; 0,</span>\n    <span class=\"hljs-comment\">#'is_configurable'   =&gt; 0,    </span>\n    <span class=\"hljs-comment\">#'unique'            =&gt; 0,</span>\n    <span class=\"hljs-string\">'type'</span>     =&gt; <span class=\"hljs-string\">'int'</span>,\n    <span class=\"hljs-string\">'label'</span>    =&gt; <span class=\"hljs-string\">'Quote'</span>,\n    <span class=\"hljs-string\">'input'</span>    =&gt; <span class=\"hljs-string\">'select'</span>,\n    <span class=\"hljs-string\">'source'</span>   =&gt; <span class=\"hljs-string\">'freaks_quotes/link'</span>,\n    <span class=\"hljs-string\">'frontend'</span> =&gt; <span class=\"hljs-string\">'freaks_quotes/frontend'</span>,\n    <span class=\"hljs-string\">'global'</span>   =&gt; Mage_Catalog_Model_Resource_Eav_Attribute::SCOPE_STORE,\n    <span class=\"hljs-string\">'required'</span> =&gt; <span class=\"hljs-keyword\">true</span>,\n    <span class=\"hljs-string\">'default'</span>  =&gt; <span class=\"hljs-number\">0</span>,\n    <span class=\"hljs-string\">'visible'</span>           =&gt; <span class=\"hljs-number\">1</span>,\n    <span class=\"hljs-string\">'visible_on_front'</span>  =&gt; <span class=\"hljs-number\">1</span>\n));\n \n$installer-&gt;endSetup();\n</code></pre>\n<p>С помощью метода <em>addAttribute</em> добавляем новый атрибут для продуктов в таблицу <em>eav_attribute</em>. Привел я все опции, для того, чтобы тот кто захочет поэкспериментировать, мог это сделать.</p>\n<p>Чтобы заработал <em>backend</em> нужно создать Source модель для атрибута. Сразу скажу, что этот класс должен реализовать методы интерфейса <em>Mage_Eav_Model_Entity_Attribute_Source_Interface</em>, хотя это и не проверится в нашем случае. Создаем файл <strong>app/code/local/Freaks/Quotes/Model/Link.php</strong></p>\n<pre><code class=\"hljs language-php\"><span class=\"hljs-meta\">&lt;?php</span>\n<span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">Freaks_Quotes_Model_Link</span> <span class=\"hljs-keyword\">extends</span> <span class=\"hljs-title\">Varien_Object</span>\n</span>{\n    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">getAllOptions</span><span class=\"hljs-params\">()</span> </span>{\n        $options = Mage::getResourceModel(<span class=\"hljs-string\">'freaks_quotes/quote_collection'</span>)\n            -&gt;toOptionArray();\n        array_unshift($options, <span class=\"hljs-keyword\">array</span>(<span class=\"hljs-string\">'value'</span>=&gt;<span class=\"hljs-string\">''</span>, <span class=\"hljs-string\">'label'</span>=&gt;Mage::helper(<span class=\"hljs-string\">'catalog'</span>)-&gt;__(<span class=\"hljs-string\">'-- Please Select --'</span>)));\n        <span class=\"hljs-keyword\">return</span> $options;\n    }\n}\n</code></pre>\n<p>Здесь появился новый метод о котором я не рассказывал. <em>getResourceModel</em> - возвращает Resource модель указанную в аргументе. В нашем случае берется коллекция цитат. Я использовал его только для того, чтобы уменьшить количество ненужных операций.</p>\n<p>Заходим на создание/редактирование продукта и смотрим что у нас в группе &quot;General&quot; есть новое поле</p>\n<p><img src=\"/media/assets/edit-product-quote.jpg\" alt=\"\" width=\"500\" height=\"235\"></p>\n<p>Так як хочется вывести цитату на frontend-е, то нужно создать Frontend модель. Открываем файл <strong>app/code/local/Freaks/Quotes/Model/Frontend.php</strong></p>\n<pre><code class=\"hljs language-php\"><span class=\"hljs-meta\">&lt;?php</span>\n<span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">Freaks_Quotes_Model_Frontend</span> <span class=\"hljs-keyword\">extends</span> <span class=\"hljs-title\">Mage_Eav_Model_Entity_Attribute_Frontend_Abstract</span>\n</span>{\n    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">getValue</span><span class=\"hljs-params\">(Varien_Object $object)</span>\n    </span>{\n        $quote = Mage::getModel(<span class=\"hljs-string\">'freaks_quotes/quote'</span>)-&gt;load($object-&gt;getFreaksQuotesId());\n        <span class=\"hljs-keyword\">return</span> $quote-&gt;getDscr();\n    }\n}\n</code></pre>\n<p>В метод <em>getValue</em> в нашем случае передастся объект Mage_Catalog_Model_Product (по скольку большинство моделей в Magento наследуются от Varien_Object, то условие выполнится).</p>\n<p>Вот и все идем на frontend и смотрим, что у нас выводится под продуктом</p>\n<p><img src=\"/media/assets/product-view-quote.jpg\" alt=\"\" width=\"500\" height=\"278\"></p>\n<p>Готовое решение можно скачать <app-link to=\"page\" params=\"{&quot;id&quot;:&quot;backend/2011-02/magento-eav-ili-druzhim-tsitatu-s-produktom/Freak_Quotes_Eav.zip&quot;}\">ЗДЕСЬ</app-link></p>","headings":[["sapaem-vazony","Сапаем вазоны"]],"id":"magento-eav-ili-druzhim-tsitatu-s-produktom"}