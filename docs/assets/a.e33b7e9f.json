{"title":"Баннеры в Magento или делаем статические блоки полезными","summary":"В Magento есть прекрасный механизм статических блоков. Хотя лично я никогда не\nпонимал, почему он у него такой слабый функционал. Сейчас почти нет сайта без\nрекламы или баннера. В своем большинстве на простых сайтах не нужна ротация по\nгео или еще как-то и статические блоки прекрасно бы справились с этим\nзаданием, если бы их можно было группировать\n","author":"sstotskyi","categories":["backend"],"createdAt":"2011-10-04T17:01:00.000Z","meta":{"keywords":["magento","баннеры"]},"alias":"bannery-v-magento-ili-delaem-staticheskie-bloki-poleznymi","content":"<p>Проблемы - неотъемлемая часть прогресса. Одна из них возникла передо мной, когда заказчик захотел размещать банеры на сайте под управлением Magento. Думаю большинство из нас знает любимые слова великого Цезаря: Разделяй и Властвуй. Так давайте же последуем его совету.</p>\n<h2 id=\"razdelyaem-na-gruppy\"><a name=\"razdelyaem-na-gruppy\" class=\"h-link\" href=\"#\"></a>Разделяем на группы</h2>\n<p>Для начала добавим возможность разделять статические блоки на группы через административную панель. Наверно ни для кого не секрет, что все начнется из <app-link to=\"backend\" params=\"{&quot;id&quot;:&quot;magento-sozdanie-crud-modulya&quot;}\">создания модуля</app-link> и закончится <a href=\"/media/assets/Freaks_Banners.zip\" download=\"Freaks_Banners.zip\">готовым решением</a>.</p>\n<p>Для начала напишем <strong>sql-install</strong> для модуля. С его помощью добавим новое поле в mysql таблицу cms_block и поставим на него индекс. Для того, чтобы этот код выполнился не забываем указать в конфигурационном файле модуля в секции <strong>resources</strong> setup модель!</p>\n<pre><code class=\"hljs language-php\"> <span class=\"hljs-comment\">/* <span class=\"hljs-doctag\">@var</span> $installer Mage_Core_Model_Resource_Setup */</span>\n$installer = <span class=\"hljs-keyword\">$this</span>;\n\n$installer-&gt;startSetup();\n\n$installer-&gt;run(<span class=\"hljs-string\">\"\nALTER TABLE {$this-&gt;getTable('cms/block')}\n    ADD COLUMN frk_group_id VARCHAR(255),\n    ADD INDEX frk_group_idx(frk_group_id);\n\"</span>);\n\n$installer-&gt;endSetup();\n</code></pre>\n<p>Поле текстовое, потому что в будущем понадобится прописывать имя группы в layout-update-ах. Думаю не очень читабельным будет увидеть цифру посреди xml.</p>\n<p>Поскольку переписыванием (реврайтом) коровских классов занятие довольно стремное, может повлечь за собой конфликты с другими расширениями, нужно найти подходящее событие на которое можно повесить обсервера. Более подходящего чем <strong>adminhtml_block_html_before</strong> к сожалению найти не удалось.</p>\n<p>Обсервер просто добавит новое поле в форму, но сложность в том что нужно определить, какой из блоков наша форма, именно та которая нужна</p>\n<pre><code class=\"hljs language-php\"><span class=\"hljs-meta\">&lt;?php</span>\n<span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">Freaks_Banners_Model_Observer</span>\n</span>{\n    <span class=\"hljs-comment\">/**\n     * Add a customer order comment when the order is placed.\n     * Listen \"adminhtml_block_html_before\" event\n     *\n     * <span class=\"hljs-doctag\">@param</span> Varien_Event_Observer $observer\n     * <span class=\"hljs-doctag\">@return</span> Freaks_Banners_Model_Observer\n     */</span>\n    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">addGroupField</span><span class=\"hljs-params\">(Varien_Event_Observer $observer)</span>\n    </span>{\n        $block  = $observer-&gt;getEvent()-&gt;getBlock();\n        $parent = $block-&gt;getParentBlock();\n\n        <span class=\"hljs-keyword\">if</span> (!$parent || <span class=\"hljs-string\">'cms_block_edit'</span> != $parent-&gt;getNameInLayout()) {\n            <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">$this</span>;\n        }\n\n        $model = Mage::registry(<span class=\"hljs-string\">'cms_block'</span>);\n        $form  = $block-&gt;getForm();\n        $form-&gt;getElement(<span class=\"hljs-string\">'base_fieldset'</span>)-&gt;addField(<span class=\"hljs-string\">'frk_group_id'</span>, <span class=\"hljs-string\">'select'</span>, <span class=\"hljs-keyword\">array</span>(\n            <span class=\"hljs-string\">'label'</span>     =&gt; Mage::helper(<span class=\"hljs-string\">'freaks_banners'</span>)-&gt;__(<span class=\"hljs-string\">'Group'</span>),\n            <span class=\"hljs-string\">'title'</span>     =&gt; Mage::helper(<span class=\"hljs-string\">'freaks_banners'</span>)-&gt;__(<span class=\"hljs-string\">'Group'</span>),\n            <span class=\"hljs-string\">'name'</span>      =&gt; <span class=\"hljs-string\">'frk_group_id'</span>,\n            <span class=\"hljs-string\">'required'</span>  =&gt; <span class=\"hljs-keyword\">false</span>,\n            <span class=\"hljs-string\">'options'</span>   =&gt; Mage::helper(<span class=\"hljs-string\">'freaks_banners'</span>)-&gt;getBannerGroups(),\n        ), <span class=\"hljs-string\">'identifier'</span>);\n        $form-&gt;setValues($model-&gt;getData());\n\n        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">$this</span>;\n    }\n}\n</code></pre>\n<p>Все формы в админке Magento состоят из 2 частей: контейнера и блока отвечающего за вывод формы. Контейнер определен в layout-е и имеет имя в нашем случае <strong>cms_block_edit</strong>. Поскольку он является родителем для блока контейнера формы, то можно достаточно просто его определить и добавить новое поле.</p>\n<p>Метод <strong>getBannerGroups</strong> хелпера модуля возвращает массив групп. Группы просто прописаны в коде для основных регионов в layout-е.</p>\n<pre><code class=\"hljs language-php\"><span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">Freaks_Banners_Helper_Data</span> <span class=\"hljs-keyword\">extends</span> <span class=\"hljs-title\">Mage_Core_Helper_Abstract</span>\n</span>{\n    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">getBannerGroups</span><span class=\"hljs-params\">()</span>\n    </span>{\n        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">array</span>(\n            <span class=\"hljs-string\">''</span>             =&gt; <span class=\"hljs-keyword\">$this</span>-&gt;__(<span class=\"hljs-string\">'Ungrouped'</span>),\n            <span class=\"hljs-string\">'main.top'</span>     =&gt; <span class=\"hljs-keyword\">$this</span>-&gt;__(<span class=\"hljs-string\">'Main Page Top'</span>),\n            <span class=\"hljs-string\">'category.top'</span> =&gt; <span class=\"hljs-keyword\">$this</span>-&gt;__(<span class=\"hljs-string\">'Category Top'</span>),\n            <span class=\"hljs-string\">'search.top'</span>   =&gt; <span class=\"hljs-keyword\">$this</span>-&gt;__(<span class=\"hljs-string\">'Search Top'</span>),\n            <span class=\"hljs-string\">'cart.top'</span>     =&gt; <span class=\"hljs-keyword\">$this</span>-&gt;__(<span class=\"hljs-string\">'Cart Top'</span>),\n            <span class=\"hljs-string\">'left'</span>         =&gt; <span class=\"hljs-keyword\">$this</span>-&gt;__(<span class=\"hljs-string\">'Left Column'</span>),\n            <span class=\"hljs-string\">'right'</span>        =&gt; <span class=\"hljs-keyword\">$this</span>-&gt;__(<span class=\"hljs-string\">'Right Column'</span>),\n        );\n    }\n}\n</code></pre>\n<p>Работа в административной части завершена. Приступим за написания класса, который умеет выводить статические блоки по группе.</p>\n<h2 id=\"vlastvuem-blokami\"><a name=\"vlastvuem-blokami\" class=\"h-link\" href=\"#\"></a>Властвуем блоками</h2>\n<p>Блок класса наследуется от <strong>Mage_Core_Block_Template</strong> и имеет установленный по умолчанию файл шаблона. Так же имеет геттер и сеттер для указания группы. Чтобы получить блоки из группы - существует метод <strong>getBannersCollection</strong>.</p>\n<p>Теперь добавим в layout блоки, которые будут выводить специфическую группу баннеров.</p>\n<pre><code class=\"hljs language-xml\"><span class=\"hljs-meta\">&lt;?xml version=\"1.0\"?&gt;</span>\n<span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">layout</span> <span class=\"hljs-attr\">version</span>=<span class=\"hljs-string\">\"0.1.0\"</span>&gt;</span>\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">default</span>&gt;</span>\n        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">reference</span> <span class=\"hljs-attr\">name</span>=<span class=\"hljs-string\">\"left\"</span>&gt;</span>\n            <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">block</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"freaks_banners/group\"</span> <span class=\"hljs-attr\">name</span>=<span class=\"hljs-string\">\"banner.left\"</span>&gt;</span>\n                <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">action</span> <span class=\"hljs-attr\">method</span>=<span class=\"hljs-string\">\"setGroup\"</span>&gt;</span><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">group</span>&gt;</span>left<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">group</span>&gt;</span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">action</span>&gt;</span>\n            <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">block</span>&gt;</span>\n        <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">reference</span>&gt;</span>\n        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">reference</span> <span class=\"hljs-attr\">name</span>=<span class=\"hljs-string\">\"right\"</span>&gt;</span>\n            <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">block</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"freaks_banners/group\"</span> <span class=\"hljs-attr\">name</span>=<span class=\"hljs-string\">\"banner.right\"</span>&gt;</span>\n                <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">action</span> <span class=\"hljs-attr\">method</span>=<span class=\"hljs-string\">\"setGroup\"</span>&gt;</span><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">group</span>&gt;</span>right<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">group</span>&gt;</span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">action</span>&gt;</span>\n            <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">block</span>&gt;</span>\n        <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">reference</span>&gt;</span>\n    <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">default</span>&gt;</span>\n\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">cms_index_index</span>&gt;</span>\n        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">reference</span> <span class=\"hljs-attr\">name</span>=<span class=\"hljs-string\">\"content\"</span>&gt;</span>\n            <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">block</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"freaks_banners/group\"</span> <span class=\"hljs-attr\">name</span>=<span class=\"hljs-string\">\"banner.main.top\"</span> <span class=\"hljs-attr\">before</span>=<span class=\"hljs-string\">\"-\"</span>&gt;</span>\n                <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">action</span> <span class=\"hljs-attr\">method</span>=<span class=\"hljs-string\">\"setGroup\"</span>&gt;</span><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">group</span>&gt;</span>main.top<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">group</span>&gt;</span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">action</span>&gt;</span>\n            <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">block</span>&gt;</span>\n        <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">reference</span>&gt;</span>\n    <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">cms_index_index</span>&gt;</span>\n\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">catalogsearch_result_index</span>&gt;</span>\n        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">reference</span> <span class=\"hljs-attr\">name</span>=<span class=\"hljs-string\">\"root\"</span>&gt;</span>\n            <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">block</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"freaks_banners/group\"</span> <span class=\"hljs-attr\">name</span>=<span class=\"hljs-string\">\"banner.top\"</span> <span class=\"hljs-attr\">as</span>=<span class=\"hljs-string\">\"banner_top\"</span>&gt;</span>\n                <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">action</span> <span class=\"hljs-attr\">method</span>=<span class=\"hljs-string\">\"setGroup\"</span>&gt;</span><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">group</span>&gt;</span>search.top<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">group</span>&gt;</span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">action</span>&gt;</span>\n            <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">block</span>&gt;</span>\n        <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">reference</span>&gt;</span>\n    <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">catalogsearch_result_index</span>&gt;</span>\n\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">catalog_category_view</span>&gt;</span>\n        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">reference</span> <span class=\"hljs-attr\">name</span>=<span class=\"hljs-string\">\"root\"</span>&gt;</span>\n            <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">block</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"freaks_banners/group\"</span> <span class=\"hljs-attr\">name</span>=<span class=\"hljs-string\">\"banner.top\"</span> <span class=\"hljs-attr\">as</span>=<span class=\"hljs-string\">\"banner_top\"</span>&gt;</span>\n                <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">action</span> <span class=\"hljs-attr\">method</span>=<span class=\"hljs-string\">\"setGroup\"</span>&gt;</span><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">group</span>&gt;</span>category.top<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">group</span>&gt;</span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">action</span>&gt;</span>\n            <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">block</span>&gt;</span>\n        <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">reference</span>&gt;</span>\n    <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">catalog_category_view</span>&gt;</span>\n\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">checkout_cart_index</span>&gt;</span>\n        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">reference</span> <span class=\"hljs-attr\">name</span>=<span class=\"hljs-string\">\"root\"</span>&gt;</span>\n            <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">block</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"freaks_banners/group\"</span> <span class=\"hljs-attr\">name</span>=<span class=\"hljs-string\">\"banner.top\"</span> <span class=\"hljs-attr\">as</span>=<span class=\"hljs-string\">\"banner_top\"</span>&gt;</span>\n                <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">action</span> <span class=\"hljs-attr\">method</span>=<span class=\"hljs-string\">\"setGroup\"</span>&gt;</span><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">group</span>&gt;</span>cart.top<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">group</span>&gt;</span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">action</span>&gt;</span>\n            <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">block</span>&gt;</span>\n        <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">reference</span>&gt;</span>\n    <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">checkout_cart_index</span>&gt;</span>\n<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">layout</span>&gt;</span>\n</code></pre>\n<p>Чтобы баннеры выводились сверху на таких страницах, как просмотр категории, просмотр корзины и страница поиска придется изменить стандартные файлы layout-от страницы, добавив сразу после</p>\n<pre><code class=\"hljs language-php\">..........................................................................................................\n        <span class=\"hljs-meta\">&lt;?php</span> <span class=\"hljs-keyword\">echo</span> <span class=\"hljs-keyword\">$this</span>-&gt;getChildHtml(<span class=\"hljs-string\">'header'</span>) <span class=\"hljs-meta\">?&gt;</span>\n        &lt;div <span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span>=\"<span class=\"hljs-title\">main</span>-<span class=\"hljs-title\">container</span> <span class=\"hljs-title\">col1</span>-<span class=\"hljs-title\">layout</span>\" <span class=\"hljs-title\">id</span>=\"<span class=\"hljs-title\">content</span>\"&gt;\n            &lt;<span class=\"hljs-title\">div</span> <span class=\"hljs-title\">class</span>=\"<span class=\"hljs-title\">main</span>\"&gt;\n</span></code></pre>\n<p>строку</p>\n<pre><code class=\"hljs language-php\"><span class=\"hljs-meta\">&lt;?php</span> <span class=\"hljs-keyword\">echo</span> <span class=\"hljs-keyword\">$this</span>-&gt;getChildHtml(<span class=\"hljs-string\">'banner_top'</span>) <span class=\"hljs-meta\">?&gt;</span>\n</code></pre>\n<p>Вот и все. Теперь можно создавать баннеры из админки и отображать у выбранных регионах на сайте. Результат, который получился у меня</p>\n<p><img src=\"/media/assets/banners.jpg\" alt=\"Magento banners\" loading=\"lazy\" width=\"700\" style=\"max-height: 380px;\" srcset=\"/media/assets/banners-xs.jpg 375w,/media/assets/banners.jpg 1280w\" sizes=\"(max-width: 375px) 375px,1280px\"></p>\n<p>Скачать модуль можно <a href=\"/media/assets/Freaks_Banners.zip\" download=\"Freaks_Banners.zip\">здесь</a>.</p>","headings":[["razdelyaem-na-gruppy","Разделяем на группы"],["vlastvuem-blokami","Властвуем блоками"]],"id":"bannery-v-magento-ili-delaem-staticheskie-bloki-poleznymi"}